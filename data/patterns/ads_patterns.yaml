# ADS_PATTERNS Pattern Library
# Auto-converted to dict format for consistency

pattern_id: ads.machine_readable.json_export
name: JSON Export for Audit Data
family: ADS
severity: high
description: 'Detects JSON serialization of audit data for machine-readable format
  compliance.

  FRR-ADS requires audit data to be available in machine-readable formats (JSON/XML).

  '
pattern_type: function_call
languages:
  python:
    ast_queries: &id001
    - query_type: function_call
      target: json.dumps
    - query_type: function_call
      target: JsonSerializer.Serialize
    - query_type: function_call
      target: JSON.stringify
    - query_type: function_call
      target: ObjectMapper
    regex_fallback: (json\.dumps\()|(JsonSerializer\.Serialize)|(JSON\.stringify)
  csharp:
    ast_queries: *id001
    regex_fallback: (json\.dumps\()|(JsonSerializer\.Serialize)|(JSON\.stringify)
  java:
    ast_queries: *id001
    regex_fallback: (json\.dumps\()|(JsonSerializer\.Serialize)|(JSON\.stringify)
  typescript:
    ast_queries: *id001
    regex_fallback: (json\.dumps\()|(JsonSerializer\.Serialize)|(JSON\.stringify)
finding:
  title: JSON export detected for audit data
  description: Code exports data in JSON format for machine-readable compliance
  recommendation: Ensure this export includes all required audit fields per FRR-ADS
  references:
  - FRR-ADS-01
  - FRR-ADS-02

---
pattern_id: ads.machine_readable.xml_export
name: XML Export for Audit Data
family: ADS
severity: medium
description: Detects XML serialization for machine-readable audit data
pattern_type: function_call
languages:
  python:
    ast_queries: &id001
    - query_type: function_call
      target: xml.etree.ElementTree
    - query_type: function_call
      target: XmlSerializer
    - query_type: function_call
      target: DocumentBuilder
    - query_type: function_call
      target: XMLParser
    regex_fallback: (xml\.etree\.ElementTree)|(XmlSerializer)|(xml2js|fast-xml-parser|DOMParser)
  csharp:
    ast_queries: *id001
    regex_fallback: (xml\.etree\.ElementTree)|(XmlSerializer)|(xml2js|fast-xml-parser|DOMParser)
  java:
    ast_queries: *id001
    regex_fallback: (xml\.etree\.ElementTree)|(XmlSerializer)|(xml2js|fast-xml-parser|DOMParser)
  typescript:
    ast_queries: *id001
    regex_fallback: (xml\.etree\.ElementTree)|(XmlSerializer)|(xml2js|fast-xml-parser|DOMParser)
finding:
  title: XML export detected for audit data
  description: Code exports data in XML format for machine-readable compliance
  recommendation: Validate XML schema matches FedRAMP OSCAL requirements
  references:
  - FRR-ADS-01

---
pattern_id: ads.api_endpoint.rest
name: REST API for Audit Data Access
family: ADS
severity: high
description: Detects REST API endpoints for programmatic audit data access
pattern_type: decorator
languages:
  python:
    ast_queries: &id001
    - query_type: decorator
      target: '@app.route'
    - query_type: decorator
      target: '@api.route'
    - query_type: decorator
      target: '[HttpGet]'
    - query_type: decorator
      target: '@GetMapping'
    regex_fallback: (@app\.route.*audit|@api\.route.*audit)|(\[HttpGet.*Audit\])|(@GetMapping.*audit)
  csharp:
    ast_queries: *id001
    regex_fallback: (@app\.route.*audit|@api\.route.*audit)|(\[HttpGet.*Audit\])|(@GetMapping.*audit)
  java:
    ast_queries: *id001
    regex_fallback: (@app\.route.*audit|@api\.route.*audit)|(\[HttpGet.*Audit\])|(@GetMapping.*audit)
  typescript:
    ast_queries: *id001
    regex_fallback: (@app\.route.*audit|@api\.route.*audit)|(\[HttpGet.*Audit\])|(@GetMapping.*audit)
finding:
  title: REST API endpoint for audit data access
  description: API endpoint provides programmatic access to audit data
  recommendation: Ensure endpoint requires authentication and implements rate limiting
  references:
  - FRR-ADS-03

---
pattern_id: ads.structured_logging.structured_format
name: Structured Logging Format
family: ADS
severity: high
description: Detects use of structured logging libraries for audit trails
pattern_type: import
languages:
  python:
    ast_queries: &id001
    - query_type: import_statement
      target: structlog
    - query_type: import_statement
      target: Serilog
    - query_type: import_statement
      target: logstash
    - query_type: import_statement
      target: winston
    regex_fallback: (import structlog|from structlog)|(using Serilog)|(import.*winston)
  csharp:
    ast_queries: *id001
    regex_fallback: (import structlog|from structlog)|(using Serilog)|(import.*winston)
  java:
    ast_queries: *id001
    regex_fallback: (import structlog|from structlog)|(using Serilog)|(import.*winston)
  typescript:
    ast_queries: *id001
    regex_fallback: (import structlog|from structlog)|(using Serilog)|(import.*winston)
finding:
  title: Structured logging library detected
  description: Code uses structured logging for machine-parseable audit trails
  recommendation: Configure structured logger to output JSON with required audit fields
  references:
  - FRR-ADS-02
  - KSI-MLA-01

---
pattern_id: ads.audit_fields.required_fields
name: Required Audit Fields
family: ADS
severity: critical
description: Detects presence of required audit fields (timestamp, user, action, resource)
pattern_type: configuration
languages:
  python:
    regex_fallback: (timestamp.*user.*action.*resource)|("timestamp".*"userId".*"action".*"resourceId")
  csharp:
    regex_fallback: (timestamp.*user.*action.*resource)|("timestamp".*"userId".*"action".*"resourceId")
  java:
    regex_fallback: (timestamp.*user.*action.*resource)|("timestamp".*"userId".*"action".*"resourceId")
  typescript:
    regex_fallback: (timestamp.*user.*action.*resource)|("timestamp".*"userId".*"action".*"resourceId")
finding:
  title: Required audit fields configured
  description: Logging includes required audit fields (timestamp, user, action, resource)
  recommendation: Validate all audit events include these fields consistently
  references:
  - FRR-ADS-02

---
pattern_id: ads.query_api.filtering
name: Audit Data Query API
family: ADS
severity: medium
description: Detects query/filtering capabilities for audit data retrieval
pattern_type: function_definition
languages:
  python:
    regex_fallback: (def.*query.*audit|def.*filter.*audit)|(public.*Query.*Audit|public.*Filter.*Audit)|(function.*queryAudit|function.*filterAudit)
  csharp:
    regex_fallback: (def.*query.*audit|def.*filter.*audit)|(public.*Query.*Audit|public.*Filter.*Audit)|(function.*queryAudit|function.*filterAudit)
  java:
    regex_fallback: (def.*query.*audit|def.*filter.*audit)|(public.*Query.*Audit|public.*Filter.*Audit)|(function.*queryAudit|function.*filterAudit)
  typescript:
    regex_fallback: (def.*query.*audit|def.*filter.*audit)|(public.*Query.*Audit|public.*Filter.*Audit)|(function.*queryAudit|function.*filterAudit)
finding:
  title: Audit data query API detected
  description: API provides filtering/querying capabilities for audit data
  recommendation: Ensure query API supports date range, user, and action type filters
  references:
  - FRR-ADS-03

---
pattern_id: ads.missing_machine_readable
name: Missing Machine-Readable Format
family: ADS
severity: critical
description: Detects absence of machine-readable export capabilities
pattern_type: configuration
languages:
  python: {}
  csharp: {}
  java: {}
  typescript: {}
requires_absence:
- ads.machine_readable.json_export
- ads.machine_readable.xml_export
finding:
  title: No machine-readable audit data export detected
  description: Code lacks JSON or XML export capabilities for audit data
  recommendation: Implement JSON/XML export per FRR-ADS-01 requirements
  severity: critical
  references:
  - FRR-ADS-01

---
pattern_id: ads.iac.azure_monitor_export
name: Azure Monitor Data Export
family: ADS
severity: high
description: Detects Azure Monitor data export configuration for audit data
pattern_type: resource
languages:
  bicep:
    ast_queries: &id001
    - query_type: resource_type
      target: Microsoft.Insights/dataCollectionRules
    - query_type: resource_type
      target: azurerm_monitor_data_collection_rule
    regex_fallback: (Microsoft\.Insights/dataCollectionRules)|(resource.*azurerm_monitor_data_collection_rule)
  terraform:
    ast_queries: *id001
    regex_fallback: (Microsoft\.Insights/dataCollectionRules)|(resource.*azurerm_monitor_data_collection_rule)
finding:
  title: Azure Monitor data export configured
  description: IaC configures Azure Monitor data export for audit data
  recommendation: Ensure export destination supports long-term retention (730 days)
  references:
  - FRR-ADS-01
  - FRR-ADS-04

---
pattern_id: ads.iac.log_analytics_workspace
name: Log Analytics Workspace for Audit Data
family: ADS
severity: high
description: Detects Log Analytics workspace configuration for centralized audit storage
pattern_type: resource
languages:
  bicep:
    ast_queries: &id001
    - query_type: resource_type
      target: Microsoft.OperationalInsights/workspaces
    - query_type: resource_type
      target: azurerm_log_analytics_workspace
    regex_fallback: (Microsoft\.OperationalInsights/workspaces)|(resource.*azurerm_log_analytics_workspace)|(retention_in_days\s*=\s*730)
  terraform:
    ast_queries: *id001
    regex_fallback: (Microsoft\.OperationalInsights/workspaces)|(resource.*azurerm_log_analytics_workspace)|(retention_in_days\s*=\s*730)
finding:
  title: Log Analytics workspace for audit data
  description: IaC provisions Log Analytics for centralized audit storage
  recommendation: Verify retention is set to 730 days minimum for FedRAMP compliance
  references:
  - FRR-ADS-04
  - KSI-MLA-01

---
pattern_id: ads.cicd.audit_export_step
name: CI/CD Audit Data Export Step
family: ADS
severity: medium
description: Detects CI/CD pipeline step for automated audit data export
pattern_type: pipeline
languages:
  github_actions:
    regex_fallback: (name:.*[Ee]xport.*[Aa]udit|run:.*export.*audit)|(displayName:.*Export
      Audit|script:.*export.*audit)|(script:.*audit.*export)
  azure_pipelines:
    regex_fallback: (name:.*[Ee]xport.*[Aa]udit|run:.*export.*audit)|(displayName:.*Export
      Audit|script:.*export.*audit)|(script:.*audit.*export)
  gitlab_ci:
    regex_fallback: (name:.*[Ee]xport.*[Aa]udit|run:.*export.*audit)|(displayName:.*Export
      Audit|script:.*export.*audit)|(script:.*audit.*export)
finding:
  title: Automated audit data export in CI/CD
  description: CI/CD pipeline includes automated audit data export step
  recommendation: Schedule regular exports and validate format compliance
  references:
  - FRR-ADS-01
