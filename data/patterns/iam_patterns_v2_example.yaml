# IAM Pattern Library - V2 Schema Example
# 
# This file demonstrates the complete V2 pattern schema with all evidence collection,
# automation, implementation, and SSP mapping fields that enable full replacement of
# traditional analyzers.

---
pattern_id: "iam.mfa.phishing_resistant_complete"
name: "Phishing-Resistant MFA - Complete Implementation"
description: "Comprehensive pattern detecting phishing-resistant MFA implementation across all languages and providing complete guidance for KSI-IAM-01 compliance"
family: "IAM"
severity: "HIGH"  # HIGH if missing, INFO if properly implemented
pattern_type: "security_control"

# ============================================================================
# DETECTION LOGIC (Existing V1 Schema - Enhanced)
# ============================================================================

languages:
  python:
    ast_queries:
      - query_type: "import_statement"
        target: "fido2|webauthn"
        match_type: "contains"
        positive: true
        description: "FIDO2/WebAuthn library import (phishing-resistant)"
      
      - query_type: "import_statement"
        target: "pyotp|twilio"
        match_type: "contains"
        positive: false
        description: "TOTP/SMS library (NOT phishing-resistant)"
    
    regex_fallback: "import\\s+(fido2|webauthn)|from\\s+(fido2|webauthn)"
    
    positive_indicators:
      - "fido2"
      - "webauthn"
      - "py_webauthn"
      - "Fido2Server"
      - "RelyingParty"
    
    negative_indicators:
      - "pyotp"
      - "twilio"
      - "sms.*mfa"
      - "totp.*only"
    
    frameworks:
      - name: "Django"
        indicators: ["django_otp", "django_two_factor"]
        recommendation: "Use django-webauthn for phishing-resistant MFA"
        
      - name: "Flask"
        indicators: ["flask_security", "flask_login"]
        recommendation: "Use Flask-WebAuthn extension"
  
  csharp:
    ast_queries:
      - query_type: "using_directive"
        target: "Fido2NetLib|WebAuthn"
        positive: true
        description: "FIDO2 library for .NET"
    
    regex_fallback: "using\\s+Fido2NetLib"
    
    positive_indicators:
      - "Fido2NetLib"
      - "Fido2.Configuration"
      - "MakeCredentialAsync"
    
    frameworks:
      - name: "ASP.NET Core"
        indicators: ["Microsoft.AspNetCore.Authentication"]
        recommendation: "Use Fido2NetLib with ASP.NET Core Identity"
  
  java:
    ast_queries:
      - query_type: "import_declaration"
        target: "com.yubico.webauthn"
        positive: true
    
    positive_indicators:
      - "com.yubico.webauthn"
      - "RelyingParty"
      - "PublicKeyCredential"
  
  typescript:
    ast_queries:
      - query_type: "import_statement"
        target: "@simplewebauthn|webauthn"
        positive: true
    
    positive_indicators:
      - "@simplewebauthn/server"
      - "@simplewebauthn/browser"
  
  bicep:
    ast_queries:
      - query_type: "resource_property"
        resource_type: "Microsoft.Authorization/policyAssignments"
        property: "conditionalAccess"
        positive: true
      
      - query_type: "resource_property"
        resource_type: "Microsoft.Authorization/policyAssignments"
        property_path: "properties.strongAuthenticationMethod"
        expected_value: "fido2|certificate"
        positive: true
    
    regex_fallback: "Microsoft\\.Authorization.*strongAuthenticationMethod"
    
    templates:
      - name: "Conditional Access Policy for Phishing-Resistant MFA"
        path: "templates/bicep/iam/conditional-access-phishing-resistant.bicep"
  
  terraform:
    ast_queries:
      - query_type: "resource_block"
        resource_type: "azuread_conditional_access_policy"
        property: "grant_controls.authentication_strength"
        expected_value: "phishing_resistant"
        positive: true
    
    regex_fallback: "resource\\s+\"azuread_conditional_access_policy\""
    
    templates:
      - name: "Conditional Access Policy"
        path: "templates/terraform/iam/conditional-access.tf"
  
  github_actions:
    ast_queries:
      - query_type: "workflow_step"
        uses: "azure/login@v1"
        with_contains: "enable-AzPSSession"
        description: "Azure login in GitHub Actions"
    
    regex_fallback: "uses:\\s*azure/login@v1"
    
    recommendations:
      - "Use OIDC authentication with federated credentials (phishing-resistant)"
      - "Avoid storing service principal secrets in GitHub Secrets"
  
  azure_pipelines:
    ast_queries:
      - query_type: "task"
        task_name: "AzureCLI"
        description: "Azure CLI task in Azure Pipelines"
    
    recommendations:
      - "Use service connections with managed identities"
      - "Avoid username/password authentication"

# ============================================================================
# FINDING GENERATION (Existing V1 Schema - Enhanced)
# ============================================================================

finding:
  title_template: "{severity} - Phishing-Resistant MFA {status} for {language}"
  
  description_template: |
    {details}
    
    **Requirement:** KSI-IAM-01 requires phishing-resistant MFA (FIDO2/WebAuthn, 
    certificate-based, or hardware tokens) for ALL user authentication.
    
    **Current State:** {current_state}
    
    **Risk:** Phishing attacks can compromise TOTP/SMS-based MFA. FIDO2/WebAuthn 
    provides cryptographic proof of origin and prevents replay attacks.
  
  remediation_template: |
    ## Recommended Solution
    
    {language_specific_remediation}
    
    ## Azure Implementation
    
    ### Option 1: Microsoft Entra ID Conditional Access (Recommended)
    
    ```bicep
    resource conditionalAccessPolicy 'Microsoft.Authorization/policyAssignments@2022-06-01' = {
      name: 'require-phishing-resistant-mfa'
      properties: {
        displayName: 'Require Phishing-Resistant MFA for All Users'
        policyDefinitionId: '/providers/Microsoft.Authorization/policyDefinitions/...'
        parameters: {
          authenticationStrength: {
            value: 'phishingResistant'
          }
        }
      }
    }
    ```
    
    ### Option 2: Application-Level FIDO2 (Python Example)
    
    ```python
    from fido2.server import Fido2Server
    from fido2.webauthn import PublicKeyCredentialRpEntity
    
    # Configure FIDO2 server
    rp = PublicKeyCredentialRpEntity(name="Your App", id="yourdomain.com")
    server = Fido2Server(rp)
    
    # Registration
    options, state = server.register_begin(user)
    
    # Authentication
    credentials = server.register_complete(state, client_data, att_obj)
    ```
    
    ### Option 3: Certificate-Based Authentication
    
    ```bicep
    resource certificateAuth 'Microsoft.AAD/domainServices@2021-05-01' = {
      properties: {
        ldapsSettings: {
          certificateAuthenticationEnabled: true
        }
      }
    }
    ```
    
    ## References
    - KSI-IAM-01: Phishing-Resistant MFA
    - NIST SP 800-63B Section 5.1.3
    - Azure Well-Architected Framework: Security - Identity
    - Microsoft Entra ID Authentication Methods: https://learn.microsoft.com/entra/identity/authentication/concept-authentication-methods

  # Template variables populated during analysis
  template_variables:
    severity: "HIGH|INFO"
    status: "Missing|Implemented|Partially Implemented"
    language: "Python|C#|Java|TypeScript|Bicep|Terraform"
    details: "Specific findings from code analysis"
    current_state: "Description of what was found"
    language_specific_remediation: "Code examples for detected language"

# ============================================================================
# EVIDENCE COLLECTION (NEW - Replaces get_evidence_collection_queries)
# ============================================================================

evidence_collection:
  azure_monitor_kql:
    - query: |
        SigninLogs
        | where TimeGenerated > ago(30d)
        | where ResultType == "0"  // Successful sign-ins
        | extend AuthMethod = tostring(parse_json(AuthenticationDetails)[0].authenticationMethod)
        | summarize 
            TotalSignIns = count(),
            FIDO2SignIns = countif(AuthMethod == "FIDO2"),
            PhishingResistantPct = round(100.0 * countif(AuthMethod in ("FIDO2", "Certificate")), 2)
          by bin(TimeGenerated, 1d), UserPrincipalName
        | where PhishingResistantPct < 100
      description: "Identify users not using phishing-resistant MFA"
      retention_days: 90
      output_fields: ["TimeGenerated", "UserPrincipalName", "PhishingResistantPct"]
      schedule: "daily"
      alert_threshold: "PhishingResistantPct < 95"
    
    - query: |
        AuditLogs
        | where TimeGenerated > ago(7d)
        | where OperationName == "Register security info"
        | extend MfaMethod = tostring(parse_json(TargetResources)[0].modifiedProperties[0].newValue)
        | summarize RegisteredMethods = make_set(MfaMethod) by UserPrincipalName
        | where RegisteredMethods !has "FIDO2"
      description: "Users without FIDO2 registered"
      retention_days: 30
      alert_threshold: "any_results"
  
  azure_cli:
    - command: "az ad user list --query \"[?userType=='Member'].{UPN:userPrincipalName, MFA:strongAuthenticationMethods}\""
      description: "List all users and their registered MFA methods"
      output_format: "json"
      frequency: "weekly"
      save_to: "evidence/mfa_methods_{date}.json"
    
    - command: "az ad policy list --query \"[?contains(displayName, 'Conditional Access')].{Name:displayName, State:state, Conditions:conditions}\""
      description: "Conditional Access policies configuration"
      output_format: "json"
      frequency: "monthly"
      save_to: "evidence/conditional_access_{date}.json"
  
  powershell:
    - script: |
        Connect-MgGraph -Scopes "Policy.Read.All"
        $policies = Get-MgIdentityConditionalAccessPolicy
        $policies | Where-Object { 
          $_.GrantControls.AuthenticationStrength -eq 'phishingResistant' 
        } | Export-Csv -Path "evidence/ca_policies.csv"
      description: "Export phishing-resistant MFA policies"
      modules_required: ["Microsoft.Graph.Identity.SignIns"]
      frequency: "monthly"
    
    - script: |
        Get-MgUserAuthenticationMethod -UserId "all" | 
        Where-Object { $_.'@odata.type' -eq '#microsoft.graph.fido2AuthenticationMethod' } |
        Export-Csv -Path "evidence/fido2_registrations.csv"
      description: "List all FIDO2 security key registrations"
      modules_required: ["Microsoft.Graph.Users"]
      frequency: "weekly"
  
  rest_api:
    - query: "GET https://graph.microsoft.com/v1.0/identity/conditionalAccess/policies"
      endpoint: "https://graph.microsoft.com/v1.0/identity/conditionalAccess/policies"
      method: "GET"
      description: "Conditional Access policies via Graph API"
      authentication: "managed_identity"
      response_format: "json"
      save_to: "evidence/graph_ca_policies_{date}.json"
    
    - query: "GET https://graph.microsoft.com/beta/reports/authenticationMethods/userRegistrationDetails"
      endpoint: "https://graph.microsoft.com/beta/reports/authenticationMethods/userRegistrationDetails"
      method: "GET"
      description: "User MFA registration status"
      authentication: "managed_identity"
      response_format: "json"
      save_to: "evidence/mfa_registration_{date}.json"

# ============================================================================
# EVIDENCE ARTIFACTS (NEW - Replaces get_evidence_artifacts)
# ============================================================================

evidence_artifacts:
  - artifact_type: "configuration"
    name: "Conditional Access Policy Configuration"
    source: "Microsoft Entra ID"
    collection_method: "Azure Portal Export or Graph API"
    frequency: "monthly"
    retention_months: 12
    format: "JSON"
    location: "evidence/conditional_access/"
    description: "JSON export of all Conditional Access policies requiring phishing-resistant MFA"
    validation: "Verify policies require authenticationStrength = 'phishingResistant'"
  
  - artifact_type: "report"
    name: "MFA Method Usage Report"
    source: "Sign-in Logs"
    collection_method: "Azure Monitor KQL query"
    frequency: "weekly"
    retention_months: 12
    format: "CSV"
    location: "evidence/mfa_usage/"
    description: "Weekly report showing percentage of sign-ins using phishing-resistant methods"
    validation: "Target: 100% phishing-resistant by end of implementation period"
  
  - artifact_type: "logs"
    name: "Sign-in Logs with MFA Events"
    source: "Azure Monitor"
    collection_method: "Continuous export to Log Analytics"
    frequency: "real-time"
    retention_months: 12
    format: "JSON"
    location: "Log Analytics Workspace"
    description: "All sign-in events including MFA method used"
    validation: "Verify logs contain authenticationMethod field"
  
  - artifact_type: "report"
    name: "FIDO2 Registration Status"
    source: "Microsoft Graph API"
    collection_method: "PowerShell script using Microsoft.Graph module"
    frequency: "monthly"
    retention_months: 12
    format: "CSV"
    location: "evidence/fido2_registration/"
    description: "List of all users with registered FIDO2 security keys"
    validation: "Target: 100% of active users have FIDO2 registered"
  
  - artifact_type: "screenshot"
    name: "Azure Portal MFA Configuration Screenshots"
    source: "Azure Portal"
    collection_method: "Manual screenshot"
    frequency: "quarterly"
    retention_months: 12
    format: "PNG"
    location: "evidence/screenshots/"
    description: "Screenshots showing MFA method settings in Entra ID"
    validation: "Show SMS/Voice disabled, FIDO2/Certificate enabled"

# ============================================================================
# AUTOMATION RECOMMENDATIONS (NEW - Replaces get_evidence_automation_recommendations)
# ============================================================================

automation:
  conditional_access_deployment:
    description: "Automate deployment of Conditional Access policies requiring phishing-resistant MFA"
    implementation: |
      # Bicep template for Conditional Access Policy
      resource phishingResistantPolicy 'Microsoft.Authorization/policyAssignments@2022-06-01' = {
        name: 'ca-phishing-resistant-mfa'
        properties: {
          displayName: 'Require Phishing-Resistant MFA'
          policyDefinitionId: resourceId('Microsoft.Authorization/policyDefinitions', 'ca-custom-phishing-resistant')
          parameters: {
            includeUsers: {
              value: 'All'
            }
            authenticationStrength: {
              value: 'phishingResistant'
            }
          }
        }
      }
    azure_services: 
      - "Microsoft Entra ID"
      - "Conditional Access"
      - "Azure Policy"
    effort_hours: 4
    prerequisites:
      - "Azure subscription with Global Administrator or Conditional Access Administrator role"
      - "Microsoft Entra ID Premium P2 license"
    validation_steps:
      - "Test with pilot user group first"
      - "Verify break-glass accounts excluded"
      - "Monitor sign-in failures for 48 hours before enforcing"
  
  mfa_registration_monitoring:
    description: "Automate monitoring of FIDO2 registration status with alerts for unregistered users"
    implementation: |
      # Azure Function (Python) to check registration status
      import azure.functions as func
      from msgraph import GraphServiceClient
      
      async def check_mfa_registration(req: func.HttpRequest) -> func.HttpResponse:
          client = GraphServiceClient(credentials, scopes)
          
          users = await client.users.get()
          unregistered = []
          
          for user in users.value:
              methods = await client.users.by_user_id(user.id).authentication.methods.get()
              has_fido2 = any(m.odata_type == "#microsoft.graph.fido2AuthenticationMethod" 
                            for m in methods.value)
              if not has_fido2:
                  unregistered.append(user.user_principal_name)
          
          # Send alert if unregistered users found
          if unregistered:
              send_alert(f"{len(unregistered)} users without FIDO2: {unregistered[:5]}")
          
          return func.HttpResponse(f"Checked {len(users.value)} users")
    azure_services:
      - "Azure Functions"
      - "Microsoft Graph API"
      - "Azure Monitor"
      - "Logic Apps (for alerts)"
    effort_hours: 8
    schedule: "daily"
    alert_channels: ["Email", "Teams", "Azure Monitor Alert"]
  
  evidence_collection_automation:
    description: "Automate monthly evidence collection for KSI-IAM-01 compliance"
    implementation: |
      # PowerShell script for automated evidence collection
      # Run: Schedule as Azure Automation Runbook
      
      param(
          [string]$StorageAccountName,
          [string]$ContainerName = "fedramp-evidence"
      )
      
      Connect-MgGraph -Identity  # Uses managed identity
      
      $date = Get-Date -Format "yyyy-MM-dd"
      
      # 1. Export Conditional Access policies
      $policies = Get-MgIdentityConditionalAccessPolicy
      $policies | ConvertTo-Json -Depth 10 | 
        Out-File "ca_policies_$date.json"
      
      # 2. Export MFA registration status
      $users = Get-MgUser -All
      $registrations = @()
      foreach ($user in $users) {
          $methods = Get-MgUserAuthenticationMethod -UserId $user.Id
          $hasFido2 = $methods | Where-Object { 
            $_.'@odata.type' -eq '#microsoft.graph.fido2AuthenticationMethod' 
          }
          $registrations += [PSCustomObject]@{
              UserPrincipalName = $user.UserPrincipalName
              HasFIDO2 = ($null -ne $hasFido2)
              RegisteredMethods = ($methods.'@odata.type' -join ', ')
          }
      }
      $registrations | Export-Csv "mfa_registration_$date.csv" -NoTypeInformation
      
      # 3. Run KQL query for sign-in analysis
      $kqlQuery = @"
      SigninLogs
      | where TimeGenerated > ago(30d)
      | extend AuthMethod = parse_json(AuthenticationDetails)[0].authenticationMethod
      | summarize PhishingResistantPct = 100.0 * countif(AuthMethod in ("FIDO2", "Certificate"))
      "@
      # Execute query and save results...
      
      # 4. Upload to Azure Storage
      $ctx = New-AzStorageContext -StorageAccountName $StorageAccountName -UseConnectedAccount
      Upload-AzStorageBlob -File "ca_policies_$date.json" -Container $ContainerName -Context $ctx
      Upload-AzStorageBlob -File "mfa_registration_$date.csv" -Container $ContainerName -Context $ctx
    azure_services:
      - "Azure Automation"
      - "Azure Storage"
      - "Microsoft Graph API"
      - "Log Analytics"
    effort_hours: 6
    schedule: "monthly (1st of month)"
    retention_policy: "12 months in Azure Blob Storage (Cool tier)"
  
  cicd_validation:
    description: "Integrate MFA configuration validation in CI/CD pipelines"
    implementation: |
      # GitHub Actions workflow step
      - name: Validate MFA Configuration
        uses: azure/CLI@v1
        with:
          inlineScript: |
            # Check if Bicep templates enforce phishing-resistant MFA
            echo "Validating Conditional Access policies..."
            
            bicep_files=$(find . -name "*.bicep")
            for file in $bicep_files; do
              if grep -q "Microsoft.Authorization/policyAssignments" "$file"; then
                if ! grep -q "phishingResistant\|fido2\|certificate" "$file"; then
                  echo "ERROR: $file missing phishing-resistant MFA requirement"
                  exit 1
                fi
              fi
            done
            
            echo "All Bicep templates validated successfully"
    azure_services:
      - "GitHub Actions"
      - "Azure CLI"
    effort_hours: 2
    integration_points: ["pre-commit", "pull-request", "deployment"]

# ============================================================================
# IMPLEMENTATION GUIDANCE (NEW - Replaces implementation checklist in metadata)
# ============================================================================

implementation:
  prerequisites:
    - "Azure subscription with Global Administrator or Conditional Access Administrator role"
    - "Microsoft Entra ID Premium P2 licenses for all users"
    - "Break-glass emergency access accounts configured and excluded"
    - "Communication plan for user FIDO2 key distribution"
  
  steps:
    - step: 1
      action: "Enable Microsoft Entra ID Premium P2"
      azure_service: "Microsoft Entra ID"
      estimated_hours: 0.5
      validation: "az ad sp show --id <app-id> --query 'appRoles' | grep Premium"
      bicep_template: null
      terraform_template: null
      notes: "Required for Conditional Access and authentication strength policies"
    
    - step: 2
      action: "Create authentication strength policy for phishing-resistant MFA"
      azure_service: "Conditional Access"
      estimated_hours: 1
      validation: "Verify policy visible in Azure Portal > Entra ID > Security > Authentication methods > Authentication strength"
      bicep_template: "templates/bicep/iam/authentication-strength.bicep"
      terraform_template: "templates/terraform/iam/authentication-strength.tf"
      notes: |
        Policy should include:
        - FIDO2 security keys
        - Windows Hello for Business
        - Certificate-based authentication
        - Exclude: TOTP, SMS, Voice
    
    - step: 3
      action: "Deploy Conditional Access policy requiring phishing-resistant MFA"
      azure_service: "Conditional Access"
      estimated_hours: 2
      validation: |
        Test with pilot users:
        1. Attempt sign-in with TOTP (should be blocked)
        2. Attempt sign-in with FIDO2 (should succeed)
      bicep_template: "templates/bicep/iam/conditional-access-phishing-resistant.bicep"
      terraform_template: "templates/terraform/iam/conditional-access.tf"
      notes: |
        Start with report-only mode for 2 weeks
        Monitor impact before enforcing
        Ensure break-glass accounts excluded
    
    - step: 4
      action: "Disable legacy MFA methods (SMS, Voice, TOTP-only apps)"
      azure_service: "Microsoft Entra ID"
      estimated_hours: 1
      validation: "az ad policy list --query \"[?displayName=='Authentication Methods Policy'].{Methods:authenticationMethodConfigurations}\""
      notes: |
        Disable in this order:
        1. Voice calls
        2. SMS
        3. Third-party TOTP apps (keep Microsoft Authenticator as backup)
    
    - step: 5
      action: "Distribute FIDO2 security keys to all users"
      azure_service: "Microsoft Entra ID"
      estimated_hours: 40  # Depends on organization size
      validation: "PowerShell script to check registration status (see automation section)"
      notes: |
        Recommended vendors: YubiKey, Feitian
        Provide 2 keys per user (primary + backup)
        Include registration instructions
    
    - step: 6
      action: "Configure Windows Hello for Business (for Windows users)"
      azure_service: "Microsoft Intune"
      estimated_hours: 4
      validation: "Check Intune compliance reports for WHfB deployment"
      bicep_template: "templates/bicep/iam/windows-hello.bicep"
      notes: |
        Deploy via Intune configuration profile
        Require PIN + biometric or security key
    
    - step: 7
      action: "Set up continuous monitoring and evidence collection"
      azure_service: "Azure Monitor"
      estimated_hours: 6
      validation: "Verify KQL queries return expected data in Log Analytics"
      notes: "Use automation scripts from automation section"
    
    - step: 8
      action: "Enable report-only mode for Conditional Access policy"
      azure_service: "Conditional Access"
      estimated_hours: 0.5
      validation: "Monitor sign-in logs for 'Report-only' results"
      notes: "Run for minimum 2 weeks, review impact reports daily"
    
    - step: 9
      action: "Enforce Conditional Access policy (enable)"
      azure_service: "Conditional Access"
      estimated_hours: 0.5
      validation: "Test sign-in with non-phishing-resistant method (should fail)"
      notes: |
        Monitor support tickets closely for first 48 hours
        Have rollback plan ready
        Ensure helpdesk trained on FIDO2 troubleshooting
    
    - step: 10
      action: "Document implementation in System Security Plan (SSP)"
      azure_service: null
      estimated_hours: 4
      validation: "SSP review by security team"
      notes: "Use SSP templates from ssp_mapping section below"
  
  validation_queries:
    - description: "Verify all active users have FIDO2 registered"
      query: "Get-MgUser -All | ForEach-Object { Get-MgUserAuthenticationMethod -UserId $_.Id | Where-Object { $_.'@odata.type' -eq '#microsoft.graph.fido2AuthenticationMethod' } }"
      expected_result: "100% of users return results"
    
    - description: "Verify no sign-ins using SMS/Voice in last 30 days"
      query: |
        SigninLogs
        | where TimeGenerated > ago(30d)
        | extend AuthMethod = parse_json(AuthenticationDetails)[0].authenticationMethod
        | where AuthMethod in ("SMS", "Voice")
        | summarize Count = count()
      expected_result: "Count = 0"
    
    - description: "Verify Conditional Access policy is enforced"
      query: "az ad policy list --query \"[?displayName=='Require Phishing-Resistant MFA'].state\""
      expected_result: "enabled"
  
  total_effort_hours: 64
  implementation_timeline: "6-8 weeks (includes pilot period)"
  rollback_plan: |
    Emergency rollback steps:
    1. Set Conditional Access policy to report-only mode (immediate)
    2. Re-enable SMS/Voice MFA (within 5 minutes)
    3. Communicate to users via email/Teams
    4. Investigate root cause before re-attempting enforcement
    
    Break-glass account access:
    - Maintain 2 break-glass accounts excluded from all CA policies
    - Store credentials in physical safe
    - Test quarterly

# ============================================================================
# SSP MAPPING (NEW - For System Security Plan generation)
# ============================================================================

ssp_mapping:
  control_family: "IA - Identification and Authentication"
  control_numbers: 
    - "IA-2"
    - "IA-2(1)"
    - "IA-2(2)"
    - "IA-2(8)"
    - "IA-5"
  
  ssp_sections:
    - section: "IA-2: Identification and Authentication (Organizational Users)"
      description_template: |
        The {system_name} enforces multi-factor authentication (MFA) for all organizational 
        users accessing the system. MFA is implemented using phishing-resistant methods 
        that prevent interception and impersonation attacks.
        
        **Implementation:**
        - Microsoft Entra ID Conditional Access policies require phishing-resistant MFA
        - Approved methods: FIDO2 security keys, Windows Hello for Business, certificate-based authentication
        - Legacy methods disabled: SMS, voice calls, TOTP-only applications
        - Authentication strength policy enforces phishing-resistant methods
        
        **Technical Controls:**
        - FIDO2/WebAuthn cryptographic authentication
        - Public key cryptography prevents credential theft
        - Origin validation prevents phishing sites from capturing credentials
        - Replay protection through challenge-response protocol
      
      implementation_details: |
        Microsoft Entra ID Conditional Access enforces phishing-resistant MFA through:
        
        1. **Authentication Strength Policy:**
           - Policy ID: {policy_id}
           - Allowed methods: FIDO2, WHfB, X.509 certificates
           - Blocked methods: SMS, Voice, TOTP
        
        2. **Conditional Access Policy:**
           - Name: "Require Phishing-Resistant MFA"
           - Applies to: All users (except break-glass accounts)
           - Conditions: All cloud apps, all locations
           - Grant controls: Require authentication strength = phishingResistant
        
        3. **User Enrollment:**
           - 100% of active users have registered FIDO2 security keys
           - Each user issued 2 keys (primary + backup)
           - Windows users also enrolled in Windows Hello for Business
      
      evidence_references:
        - "Conditional Access policy configuration (JSON export)"
        - "Sign-in logs showing MFA method usage (last 30 days)"
        - "FIDO2 registration status report"
        - "Authentication Methods Policy configuration"
        - "Azure Monitor dashboard showing 100% phishing-resistant auth"
      
      responsible_role: "Identity and Access Management Administrator"
      review_frequency: "Quarterly"
    
    - section: "IA-2(1): Multi-factor Authentication to Privileged Accounts"
      description_template: |
        The {system_name} requires phishing-resistant multi-factor authentication for 
        all privileged accounts, including:
        - Global Administrators
        - Privileged Role Administrators  
        - Security Administrators
        - All accounts with write access to security-relevant resources
        
        Privileged accounts are subject to additional monitoring and cannot use 
        legacy MFA methods under any circumstances.
      
      implementation_details: |
        Privileged account protection:
        
        1. **Dedicated Conditional Access Policy:**
           - Higher priority than standard user policy
           - No exceptions allowed (except 2 break-glass accounts)
           - Requires re-authentication every 4 hours
        
        2. **Privileged Identity Management (PIM):**
           - Just-in-time access activation
           - MFA required at activation time
           - Time-limited role assignments (max 8 hours)
        
        3. **Enhanced Monitoring:**
           - All privileged account sign-ins logged to SIEM
           - Alerts for any non-FIDO2 authentication attempts
           - Monthly access reviews
      
      evidence_references:
        - "PIM activation logs with MFA events"
        - "Conditional Access policy for privileged users"
        - "Privileged account sign-in logs (100% FIDO2)"
        - "Access review reports"
    
    - section: "IA-2(2): Multi-factor Authentication to Non-privileged Accounts"
      description_template: |
        The {system_name} requires phishing-resistant multi-factor authentication for 
        all non-privileged user accounts. Standard users must use FIDO2 security keys 
        or Windows Hello for Business for all authentication events.
      
      implementation_details: |
        Standard user MFA enforcement:
        - Same authentication strength requirement as privileged users
        - FIDO2 security key or Windows Hello for Business required
        - Re-authentication required every 8 hours for continuous access
        - Offline access: Windows Hello for Business supports offline unlock
      
      evidence_references:
        - "User sign-in logs showing MFA method distribution"
        - "FIDO2 registration compliance report (100% enrollment)"
    
    - section: "IA-2(8): Access to Accounts — Replay Resistant"
      description_template: |
        The {system_name} implements replay-resistant authentication mechanisms that 
        prevent replay attacks through cryptographic challenge-response protocols.
        
        **FIDO2/WebAuthn Replay Protection:**
        - Each authentication generates unique cryptographic signature
        - Challenge value includes timestamp and origin
        - Private key never leaves hardware security key
        - Replay of previous authentication responses will fail validation
      
      implementation_details: |
        Replay resistance mechanisms:
        
        1. **FIDO2 Protocol:**
           - Server generates random challenge for each authentication
           - Client signs challenge with private key from security key
           - Server validates signature using public key
           - Signature includes origin and challenge, making it unique
        
        2. **Windows Hello for Business:**
           - TPM-backed key storage prevents key extraction
           - Challenge-response using TPM-protected private key
           - Each authentication uses fresh nonce
        
        3. **Certificate-Based Authentication:**
           - X.509 certificate with private key on smart card
           - Challenge-response protocol prevents replay
      
      evidence_references:
        - "FIDO2 protocol compliance documentation"
        - "Windows Hello for Business configuration showing TPM requirement"
        - "Zero replay attack incidents in last 12 months"
    
    - section: "IA-5: Authenticator Management"
      description_template: |
        The {system_name} manages authenticators (FIDO2 security keys, biometric 
        data, certificates) according to FedRAMP requirements.
        
        **Authenticator Lifecycle:**
        - Procurement: FIDO2 Certified keys from approved vendors
        - Distribution: Secure delivery to users with registration instructions
        - Registration: Self-service via Microsoft Entra ID MyAccount portal
        - Revocation: Immediate remote wipe capability for lost/stolen keys
        - Replacement: New key provisioned within 1 business day
      
      implementation_details: |
        Authenticator management procedures:
        
        1. **Approved FIDO2 Keys:**
           - YubiKey 5 Series (USB-A, USB-C, NFC)
           - Feitian BioPass K27
           - All keys must be FIDO2 Level 2 certified
        
        2. **Registration Process:**
           - User receives 2 keys (primary + backup)
           - Self-service registration via https://myaccount.microsoft.com
           - Helpdesk verification required for privileged accounts
           - Registration completion tracked via PowerShell automation
        
        3. **Lost/Stolen Key Procedure:**
           - User reports to helpdesk
           - Key revoked in Entra ID within 15 minutes
           - User authenticates with backup key
           - Replacement key shipped next business day
      
      evidence_references:
        - "FIDO2 key procurement records (vendor certification)"
        - "User registration tracking spreadsheet"
        - "Key revocation logs"
        - "Helpdesk ticket data for key replacement requests"

# ============================================================================
# METADATA (Existing V1 Schema)
# ============================================================================

tags: 
  - "mfa"
  - "authentication"
  - "phishing-resistant"
  - "fido2"
  - "webauthn"
  - "security"
  - "identity"

nist_controls: 
  - "ia-2"
  - "ia-2.1"
  - "ia-2.2"
  - "ia-2.8"
  - "ia-5"
  - "ia-8"
  - "sc-23"

related_ksis: 
  - "KSI-IAM-01"
  - "KSI-IAM-02"

related_frrs: 
  - "FRR-ADS-AC-01"

# ============================================================================
# AZURE GUIDANCE (NEW - Azure-specific recommendations)
# ============================================================================

azure_guidance:
  recommended_services:
    - service: "Microsoft Entra ID"
      tier: "Premium P2"
      purpose: "Primary identity provider with Conditional Access"
      monthly_cost_estimate: "$9 USD per user"
      alternatives: []
      justification: "Required for Conditional Access and authentication strength policies"
      
    - service: "Conditional Access"
      tier: "Included in Entra ID P2"
      purpose: "Policy enforcement for phishing-resistant MFA"
      monthly_cost_estimate: "Included"
      alternatives: []
      
    - service: "Privileged Identity Management"
      tier: "Included in Entra ID P2"
      purpose: "Just-in-time privileged access with MFA"
      monthly_cost_estimate: "Included"
      alternatives: []
      
    - service: "Microsoft Intune"
      tier: "Plan 1"
      purpose: "Windows Hello for Business deployment"
      monthly_cost_estimate: "$8 USD per user"
      alternatives: ["Third-party MDM (must support WHfB)"]
      optional: true
      
    - service: "Azure Monitor"
      tier: "Pay-as-you-go"
      purpose: "Sign-in log analysis and compliance monitoring"
      monthly_cost_estimate: "$2.30 per GB ingested"
      alternatives: []
  
  well_architected_framework:
    pillar: "Security"
    design_area: "Identity and Access Management"
    recommendation_id: "SEC-04"
    recommendation_title: "Use modern authentication protocols"
    reference_url: "https://learn.microsoft.com/azure/well-architected/security/identity"
    summary: |
      Implement phishing-resistant multi-factor authentication using FIDO2/WebAuthn 
      to prevent credential theft and phishing attacks. Avoid legacy protocols like 
      SMS and TOTP which are vulnerable to interception.
  
  cloud_adoption_framework:
    stage: "Secure"
    guidance: "Implement phishing-resistant MFA across all accounts"
    reference_url: "https://learn.microsoft.com/azure/cloud-adoption-framework/secure/best-practices/end-user-authentication"
    best_practices:
      - "Deploy passwordless authentication where possible"
      - "Use FIDO2 security keys for high-value accounts"
      - "Implement Conditional Access with authentication strength"
      - "Monitor authentication methods via Azure Monitor"
  
  security_benchmark:
    control_id: "IM-7"
    control_name: "Eliminate unintended credential exposure"
    recommendation: "Use phishing-resistant MFA to prevent credential theft"
    reference_url: "https://learn.microsoft.com/security/benchmark/azure/security-controls-v3-identity-management#im-7-eliminate-unintended-credential-exposure"

# ============================================================================
# COMPLIANCE FRAMEWORKS (NEW - Multi-framework mapping)
# ============================================================================

compliance_frameworks:
  fedramp_20x:
    requirement_id: "KSI-IAM-01"
    requirement_name: "Phishing-Resistant MFA"
    impact_levels: ["Low", "Moderate"]
    statement: "Enforce multi-factor authentication (MFA) using methods that are difficult to intercept or impersonate (phishing-resistant MFA) for all user authentication."
    
  nist_800_53_rev5:
    controls: 
      - control_id: "IA-2"
        control_name: "Identification and Authentication (Organizational Users)"
        enhancement: null
      - control_id: "IA-2(1)"
        control_name: "Multi-factor Authentication to Privileged Accounts"
        enhancement: "IA-2(1)"
      - control_id: "IA-2(2)"
        control_name: "Multi-factor Authentication to Non-privileged Accounts"
        enhancement: "IA-2(2)"
      - control_id: "IA-2(8)"
        control_name: "Access to Accounts — Replay Resistant"
        enhancement: "IA-2(8)"
    
  pci_dss_4:
    requirements:
      - requirement_id: "8.4.2"
        requirement_name: "MFA for all access into CDE"
        notes: "FIDO2 satisfies phishing-resistant requirement"
      - requirement_id: "8.4.3"
        requirement_name: "MFA for all remote access"
        notes: "Conditional Access enforces for all cloud access"
    
  hipaa:
    standards:
      - standard_id: "164.312(d)"
        standard_name: "Person or Entity Authentication"
        implementation: "FIDO2 provides strong authentication required by HIPAA"
    
  iso_27001_2022:
    controls:
      - control_id: "A.9.2.1"
        control_name: "User registration and de-registration"
        implementation: "FIDO2 key registration tracked in Entra ID"
      - control_id: "A.9.4.2"
        control_name: "Secure log-on procedures"
        implementation: "Phishing-resistant MFA for all users"

# ============================================================================
# TESTING AND VALIDATION (NEW - Embedded test cases)
# ============================================================================

testing:
  positive_test_cases:
    - description: "Python FIDO2 library import detected"
      code_sample: |
        from fido2.server import Fido2Server
        from fido2.webauthn import PublicKeyCredentialRpEntity
      expected_severity: "INFO"
      expected_finding: true
      expected_message: "Phishing-resistant MFA library detected (FIDO2)"
      
    - description: "C# FIDO2 library usage"
      code_sample: |
        using Fido2NetLib;
        using Fido2NetLib.Objects;
        
        var fido2 = new Fido2(new Fido2Configuration());
      expected_severity: "INFO"
      expected_finding: true
      
    - description: "Bicep Conditional Access with phishing-resistant auth"
      code_sample: |
        resource caPolicy 'Microsoft.Authorization/policyAssignments@2022-06-01' = {
          properties: {
            parameters: {
              authenticationStrength: {
                value: 'phishingResistant'
              }
            }
          }
        }
      expected_severity: "INFO"
      expected_finding: true
  
  negative_test_cases:
    - description: "Python TOTP library (non-phishing-resistant)"
      code_sample: |
        import pyotp
        totp = pyotp.TOTP('base32secret3232')
        totp.now()
      expected_severity: "HIGH"
      expected_finding: true
      expected_message: "TOTP-only MFA detected (not phishing-resistant)"
      
    - description: "SMS MFA via Twilio (vulnerable to phishing)"
      code_sample: |
        from twilio.rest import Client
        client = Client(account_sid, auth_token)
        message = client.messages.create(
            body="Your code is 123456",
            to="+1234567890"
        )
      expected_severity: "HIGH"
      expected_finding: true
      expected_message: "SMS-based MFA detected (vulnerable to interception)"
      
    - description: "No MFA implementation detected"
      code_sample: |
        def login(username, password):
            user = authenticate(username, password)
            if user:
                return create_session(user)
      expected_severity: "CRITICAL"
      expected_finding: true
      expected_message: "No MFA implementation detected"
  
  validation_scripts:
    - "tests/test_ksi_iam_01_patterns.py"
    - "tests/integration/test_iam_patterns_real_world.py"
  
  real_world_test_repos:
    - repo: "django/django"
      file: "django/contrib/auth/backends.py"
      expected_findings: 0
      notes: "Django core doesn't include MFA - expected"
    
    - repo: "pallets/flask"
      file: "src/flask/app.py"
      expected_findings: 0
      notes: "Flask core doesn't include MFA - expected"
