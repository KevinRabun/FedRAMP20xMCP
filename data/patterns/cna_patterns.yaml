# CNA (Cloud Native Architecture) Patterns for FedRAMP 20x Compliance
# Family: CNA - Cloud Native Architecture Requirements
# These patterns detect compliance with FRR-CNA requirements based on KSI-CNA analyzers

---
pattern_id: cna.network.nsg_configuration
name: Network Security Group Configuration
family: CNA
severity: high
description: |
  Detects Network Security Group (NSG) configuration for network traffic restriction.
  Aligns with KSI-CNA-01: Restrict Network Traffic.
pattern_type: resource
languages:
  - bicep
  - terraform
ast_queries:
  - query_type: resource_type
    target: Microsoft.Network/networkSecurityGroups
  - query_type: resource_type
    target: azurerm_network_security_group
regex_patterns:
  - pattern: 'Microsoft\.Network/networkSecurityGroups'
    flags: IGNORECASE
  - pattern: 'resource.*azurerm_network_security_group'
    flags: IGNORECASE
  - pattern: 'securityRules.*deny|security_rule.*deny'
    flags: IGNORECASE
finding_template:
  title: Network Security Group configured
  description: IaC provisions NSG for network traffic restriction
  recommendation: Ensure default deny rules and explicit allow rules per KSI-CNA-01
  references:
    - KSI-CNA-01
    - FRR-CNA-01

---
pattern_id: cna.network.azure_firewall
name: Azure Firewall Configuration
family: CNA
severity: high
description: Detects Azure Firewall for centralized network security
pattern_type: resource
languages:
  - bicep
  - terraform
ast_queries:
  - query_type: resource_type
    target: Microsoft.Network/azureFirewalls
  - query_type: resource_type
    target: azurerm_firewall
regex_patterns:
  - pattern: 'Microsoft\.Network/azureFirewalls'
    flags: IGNORECASE
  - pattern: 'resource.*azurerm_firewall'
    flags: IGNORECASE
finding_template:
  title: Azure Firewall configured for network security
  description: IaC provisions Azure Firewall for traffic filtering
  recommendation: Configure application and network rules with least privilege
  references:
    - KSI-CNA-01

---
pattern_id: cna.attack_surface.minimal_dependencies
name: Minimal Dependencies Analysis
family: CNA
severity: medium
description: |
  Detects minimal dependency usage to reduce attack surface.
  Aligns with KSI-CNA-02: Minimize the Attack Surface.
pattern_type: import
languages:
  - python
  - csharp
  - java
  - typescript
regex_patterns:
  - pattern: '^import |^from .* import |^using |^require\('
    flags: IGNORECASE
finding_template:
  title: Dependency analysis for attack surface
  description: Code imports dependencies (should be minimal)
  recommendation: Review and remove unused dependencies per KSI-CNA-02
  references:
    - KSI-CNA-02

---
pattern_id: cna.immutable_infra.container_image
name: Immutable Container Image
family: CNA
severity: high
description: |
  Detects use of container images for immutable infrastructure.
  Aligns with KSI-CNA-04: Immutable Infrastructure.
pattern_type: configuration
languages:
  - dockerfile
  - yaml
regex_patterns:
  - pattern: 'FROM.*alpine|FROM.*distroless|FROM.*scratch'
    flags: IGNORECASE
  - pattern: 'image:.*:.*@sha256:'
    flags: IGNORECASE
finding_template:
  title: Immutable container image configuration
  description: Uses minimal, immutable base images
  recommendation: Pin image versions with SHA256 digest per KSI-CNA-04
  references:
    - KSI-CNA-04

---
pattern_id: cna.iac.aks_cluster
name: Azure Kubernetes Service Configuration
family: CNA
severity: high
description: Detects AKS cluster configuration for cloud-native architecture
pattern_type: resource
languages:
  - bicep
  - terraform
ast_queries:
  - query_type: resource_type
    target: Microsoft.ContainerService/managedClusters
  - query_type: resource_type
    target: azurerm_kubernetes_cluster
regex_patterns:
  - pattern: 'Microsoft\.ContainerService/managedClusters'
    flags: IGNORECASE
  - pattern: 'resource.*azurerm_kubernetes_cluster'
    flags: IGNORECASE
  - pattern: 'networkProfile.*networkPlugin.*azure'
    flags: IGNORECASE
finding_template:
  title: AKS cluster for cloud-native architecture
  description: IaC provisions AKS cluster for containerized workloads
  recommendation: Enable network policy (Calico/Azure) and Azure Policy add-on
  references:
    - KSI-CNA-01
    - KSI-CNA-04

---
pattern_id: cna.iac.container_registry
name: Azure Container Registry Configuration
family: CNA
severity: medium
description: Detects ACR configuration for container image management
pattern_type: resource
languages:
  - bicep
  - terraform
ast_queries:
  - query_type: resource_type
    target: Microsoft.ContainerRegistry/registries
  - query_type: resource_type
    target: azurerm_container_registry
regex_patterns:
  - pattern: 'Microsoft\.ContainerRegistry/registries'
    flags: IGNORECASE
  - pattern: 'resource.*azurerm_container_registry'
    flags: IGNORECASE
  - pattern: 'sku.*Premium'
    flags: IGNORECASE
finding_template:
  title: Azure Container Registry configured
  description: IaC provisions ACR for container image storage
  recommendation: Enable vulnerability scanning and image signing per KSI-VDR-01
  references:
    - KSI-CNA-04
    - KSI-VDR-01

---
pattern_id: cna.observability.monitoring_integration
name: Cloud-Native Monitoring Integration
family: CNA
severity: high
description: |
  Detects monitoring integration for cloud-native observability.
  Aligns with KSI-CNA-08: Monitoring and Observability.
pattern_type: import
languages:
  - python
  - csharp
  - java
  - typescript
ast_queries:
  - query_type: import_statement
    target: opencensus
  - query_type: import_statement
    target: opentelemetry
  - query_type: import_statement
    target: ApplicationInsights
regex_patterns:
  - pattern: 'import.*opencensus|from opencensus'
    flags: IGNORECASE
  - pattern: 'import.*opentelemetry|from opentelemetry'
    flags: IGNORECASE
  - pattern: 'using.*ApplicationInsights'
    flags: IGNORECASE
finding_template:
  title: Cloud-native monitoring integration detected
  description: Code integrates monitoring for observability
  recommendation: Ensure metrics, logs, and traces are exported to centralized system
  references:
    - KSI-CNA-08
    - KSI-MLA-01

---
pattern_id: cna.api_gateway.configuration
name: API Gateway Configuration
family: CNA
severity: high
description: Detects API Gateway/Management configuration for cloud-native architecture
pattern_type: resource
languages:
  - bicep
  - terraform
ast_queries:
  - query_type: resource_type
    target: Microsoft.ApiManagement/service
  - query_type: resource_type
    target: azurerm_api_management
regex_patterns:
  - pattern: 'Microsoft\.ApiManagement/service'
    flags: IGNORECASE
  - pattern: 'resource.*azurerm_api_management'
    flags: IGNORECASE
finding_template:
  title: API Gateway configured for cloud-native architecture
  description: IaC provisions API Management for service exposure
  recommendation: Configure policies for rate limiting, authentication, and logging
  references:
    - KSI-CNA-01
    - FRR-CNA-02

---
pattern_id: cna.service_mesh.configuration
name: Service Mesh Configuration
family: CNA
severity: medium
description: Detects service mesh configuration for microservices communication
pattern_type: configuration
languages:
  - yaml
regex_patterns:
  - pattern: 'kind:.*VirtualService|kind:.*DestinationRule'
    flags: IGNORECASE
  - pattern: 'apiVersion:.*networking\.istio\.io'
    flags: IGNORECASE
finding_template:
  title: Service mesh configuration detected
  description: Configuration includes service mesh for secure service-to-service communication
  recommendation: Enable mTLS and configure authorization policies
  references:
    - KSI-CNA-01
    - KSI-IAM-05

---
pattern_id: cna.cicd.container_build
name: Container Build in CI/CD
family: CNA
severity: high
description: Detects container image build steps in CI/CD pipeline
pattern_type: pipeline
languages:
  - github_actions
  - azure_pipelines
  - gitlab_ci
regex_patterns:
  - pattern: 'docker build|buildx build|kaniko'
    flags: IGNORECASE
  - pattern: 'task:.*Docker@|task:.*ContainerBuild@'
    flags: IGNORECASE
finding_template:
  title: Container build in CI/CD pipeline
  description: Pipeline builds container images for cloud-native deployment
  recommendation: Scan images for vulnerabilities before pushing per KSI-VDR-01
  references:
    - KSI-CNA-04
    - KSI-VDR-01

---
pattern_id: cna.cicd.infrastructure_validation
name: Infrastructure Validation in CI/CD
family: CNA
severity: high
description: Detects IaC validation steps in CI/CD pipeline
pattern_type: pipeline
languages:
  - github_actions
  - azure_pipelines
  - gitlab_ci
regex_patterns:
  - pattern: 'bicep build|terraform validate|terraform plan'
    flags: IGNORECASE
  - pattern: 'az bicep build|checkov|tfsec'
    flags: IGNORECASE
finding_template:
  title: Infrastructure validation in CI/CD
  description: Pipeline validates IaC before deployment
  recommendation: Include security policy checks (Azure Policy, Checkov) per KSI-CNA-07
  references:
    - KSI-CNA-07
