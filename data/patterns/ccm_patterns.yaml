# CCM PATTERNS V2 - V2 Schema
# Migrated from V1 schema with enhanced evidence collection
# 
# NOTE: This is an automated migration. Manual review required for:
# - Evidence collection queries (marked with TODO)
# - Automation implementation code
# - SSP mapping descriptions
# - Test cases

pattern_id: ccm.version_control.git_usage
name: Git Version Control Usage
family: CCM
severity: high
description: 'Detects Git version control system usage for change management.

  Aligns with KSI-CMT-01: Version Control and Change Logging.

  '
pattern_type: configuration
languages:
  python:
    regex_fallback: (\.git/|\.gitignore|\.gitattributes)|(git commit|git push|git
      merge)
  csharp:
    regex_fallback: (\.git/|\.gitignore|\.gitattributes)|(git commit|git push|git
      merge)
  java:
    regex_fallback: (\.git/|\.gitignore|\.gitattributes)|(git commit|git push|git
      merge)
  typescript:
    regex_fallback: (\.git/|\.gitignore|\.gitattributes)|(git commit|git push|git
      merge)
finding:
  title: Git version control detected
  description: Project uses Git for version control and change tracking
  recommendation: Ensure all configuration changes go through Git workflow per KSI-CMT-01
  references:
  - KSI-CMT-01
  - FRR-CCM-01

---
pattern_id: ccm.change_logging.audit_log
name: Change Audit Logging
family: CCM
severity: high
description: Detects logging of configuration changes for audit trail
pattern_type: function_call
languages:
  python:
    regex_fallback: (log.*config.*change|audit.*configuration|logger.*modify)|(log\.info.*update|log\.warn.*change)
  csharp:
    regex_fallback: (log.*config.*change|audit.*configuration|logger.*modify)|(log\.info.*update|log\.warn.*change)
  java:
    regex_fallback: (log.*config.*change|audit.*configuration|logger.*modify)|(log\.info.*update|log\.warn.*change)
  typescript:
    regex_fallback: (log.*config.*change|audit.*configuration|logger.*modify)|(log\.info.*update|log\.warn.*change)
finding:
  title: Configuration change logging detected
  description: Code logs configuration changes for audit purposes
  recommendation: Include user, timestamp, old/new values per KSI-CMT-01
  references:
  - KSI-CMT-01
  - FRR-ADS-02

---
pattern_id: ccm.approval_workflow.pull_request
name: Pull Request Approval Workflow
family: CCM
severity: high
description: Detects pull request workflow for change approval
pattern_type: configuration
languages:
  yaml:
    regex_fallback: (pull_request|merge_request)|(required_approving_review_count|approval_count)|(CODEOWNERS|code-review)
finding:
  title: Pull request approval workflow configured
  description: Repository requires PR approval before merging changes
  recommendation: Require at least 2 approvals for production changes per FRR-CCM-02
  references:
  - FRR-CCM-02
  - KSI-CMT-02

---
pattern_id: ccm.automated_testing.pre_deploy
name: Automated Testing Before Deployment
family: CCM
severity: critical
description: 'Detects automated testing in CI/CD before deployment.

  Aligns with KSI-CMT-03: Automated Testing and Validation.

  '
pattern_type: pipeline
languages:
  github_actions:
    regex_fallback: (run:.*test|script:.*test|pytest|jest|mvn test)|(task:.*VSTest@|task:.*DotNetCoreCLI@.*test)
  azure_pipelines:
    regex_fallback: (run:.*test|script:.*test|pytest|jest|mvn test)|(task:.*VSTest@|task:.*DotNetCoreCLI@.*test)
  gitlab_ci:
    regex_fallback: (run:.*test|script:.*test|pytest|jest|mvn test)|(task:.*VSTest@|task:.*DotNetCoreCLI@.*test)
finding:
  title: Automated testing before deployment
  description: CI/CD pipeline runs automated tests before deployment
  recommendation: Include unit, integration, and security tests per KSI-CMT-03
  references:
  - KSI-CMT-03
  - FRR-CCM-03

---
pattern_id: ccm.rollback.capability
name: Rollback Capability
family: CCM
severity: high
description: Detects rollback capability in deployment process
pattern_type: configuration
languages:
  python:
    regex_fallback: (rollback|revert|undo.*deploy)|(previous.*version|last.*known.*good)
  csharp:
    regex_fallback: (rollback|revert|undo.*deploy)|(previous.*version|last.*known.*good)
  java:
    regex_fallback: (rollback|revert|undo.*deploy)|(previous.*version|last.*known.*good)
  typescript:
    regex_fallback: (rollback|revert|undo.*deploy)|(previous.*version|last.*known.*good)
  yaml:
    regex_fallback: (rollback|revert|undo.*deploy)|(previous.*version|last.*known.*good)
finding:
  title: Rollback capability detected
  description: Deployment process includes rollback capability
  recommendation: Test rollback procedure regularly per FRR-CCM-04
  references:
  - FRR-CCM-04

---
pattern_id: ccm.baseline.configuration
name: Baseline Configuration Management
family: CCM
severity: high
description: Detects baseline configuration management practices
pattern_type: configuration
languages:
  yaml:
    regex_fallback: (baseline|standard.*config|default.*settings)|(config.*template|configuration.*baseline)
  json:
    regex_fallback: (baseline|standard.*config|default.*settings)|(config.*template|configuration.*baseline)
finding:
  title: Baseline configuration detected
  description: Configuration includes baseline/standard settings
  recommendation: Document and version control baseline configurations per FRR-CCM-05
  references:
  - FRR-CCM-05

---
pattern_id: ccm.change_approval.explicit
name: Explicit Change Approval Check
family: CCM
severity: high
description: Detects explicit change approval checks in code
pattern_type: function_call
languages:
  python:
    regex_fallback: (check.*approval|verify.*approved|require.*authorization)|(is_approved|has_approval|approved_by)
  csharp:
    regex_fallback: (check.*approval|verify.*approved|require.*authorization)|(is_approved|has_approval|approved_by)
  java:
    regex_fallback: (check.*approval|verify.*approved|require.*authorization)|(is_approved|has_approval|approved_by)
  typescript:
    regex_fallback: (check.*approval|verify.*approved|require.*authorization)|(is_approved|has_approval|approved_by)
finding:
  title: Explicit change approval check
  description: Code enforces change approval before execution
  recommendation: Integrate with ticketing system (ServiceNow, JIRA) per FRR-CCM-02
  references:
  - FRR-CCM-02

---
pattern_id: ccm.iac.arm_template_validation
name: ARM Template Validation
family: CCM
severity: high
description: Detects ARM/Bicep template validation for IaC change management
pattern_type: pipeline
languages:
  github_actions:
    regex_fallback: (az deployment.*validate|bicep build|arm-ttk)|(task:.*AzureResourceManagerTemplateDeployment@.*validate)
  azure_pipelines:
    regex_fallback: (az deployment.*validate|bicep build|arm-ttk)|(task:.*AzureResourceManagerTemplateDeployment@.*validate)
  gitlab_ci:
    regex_fallback: (az deployment.*validate|bicep build|arm-ttk)|(task:.*AzureResourceManagerTemplateDeployment@.*validate)
finding:
  title: ARM/Bicep template validation
  description: Pipeline validates ARM templates before deployment
  recommendation: Include policy compliance checks per KSI-CNA-07
  references:
  - FRR-CCM-03
  - KSI-CNA-07

---
pattern_id: ccm.iac.terraform_plan
name: Terraform Plan for Change Preview
family: CCM
severity: high
description: Detects Terraform plan step for change preview and approval
pattern_type: pipeline
languages:
  github_actions:
    regex_fallback: (terraform plan|tf plan)|(terraform apply.*-auto-approve)
  azure_pipelines:
    regex_fallback: (terraform plan|tf plan)|(terraform apply.*-auto-approve)
  gitlab_ci:
    regex_fallback: (terraform plan|tf plan)|(terraform apply.*-auto-approve)
finding:
  title: Terraform plan for change preview
  description: Pipeline runs terraform plan to preview changes
  recommendation: Require manual approval between plan and apply per FRR-CCM-02
  references:
  - FRR-CCM-02
  - FRR-CCM-03

---
pattern_id: ccm.cicd.deployment_gate
name: Deployment Gate/Approval
family: CCM
severity: critical
description: Detects deployment gates or manual approval steps in CI/CD
pattern_type: pipeline
languages:
  github_actions:
    regex_fallback: (environment:|deployment.*gate|manual.*approval|approvals.*required|when:.*manual|name:\s*production|environment:\s*production)
  azure_pipelines:
    regex_fallback: (environment:|deployment.*gate|manual.*approval|approvals.*required|when:.*manual|name:\s*production|environment:\s*production)
  gitlab_ci:
    regex_fallback: (environment:|deployment.*gate|manual.*approval|approvals.*required|when:.*manual|name:\s*production|environment:\s*production)
finding:
  title: Deployment gate/approval configured
  description: CI/CD includes deployment gate or manual approval
  recommendation: Require approval from authorized personnel per FRR-CCM-02
  references:
  - FRR-CCM-02

---
pattern_id: ccm.cicd.configuration_backup
name: Configuration Backup Before Change
family: CCM
severity: medium
description: Detects configuration backup steps before applying changes
pattern_type: pipeline
languages:
  github_actions:
    regex_fallback: (backup.*config|snapshot.*before|export.*settings)|(az.*export|terraform.*state.*pull)
  azure_pipelines:
    regex_fallback: (backup.*config|snapshot.*before|export.*settings)|(az.*export|terraform.*state.*pull)
  gitlab_ci:
    regex_fallback: (backup.*config|snapshot.*before|export.*settings)|(az.*export|terraform.*state.*pull)
finding:
  title: Configuration backup before change
  description: Pipeline backs up configuration before applying changes
  recommendation: Store backups in immutable storage per FRR-CCM-04
  references:
  - FRR-CCM-04

---
pattern_id: ccm.missing_version_control
name: Missing Version Control Evidence
family: CCM
severity: critical
description: Detects absence of version control configuration
pattern_type: configuration
languages:
  python: {}
  csharp: {}
  java: {}
  typescript: {}
requires_absence:
- ccm.version_control.git_usage
finding:
  title: No version control evidence detected
  description: Project lacks Git or other version control system
  severity: critical
  recommendation: Implement Git version control immediately per KSI-CMT-01
  references:
  - KSI-CMT-01
  - FRR-CCM-01
