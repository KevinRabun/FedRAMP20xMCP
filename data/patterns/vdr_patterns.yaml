# VDR (Vulnerability Detection and Remediation) Pattern Library

# Vulnerability Scanning Patterns (KSI-VDR-01, KSI-VDR-02)

---
pattern_id: "vdr.scanning.defender_for_cloud"
name: "Microsoft Defender for Cloud"
description: "Detects Defender for Cloud enablement in IaC"
family: "VDR"
severity: "INFO"
pattern_type: "resource"

languages:
  bicep:
    ast_queries:
      - resource_type: "Microsoft.Security/pricings"
        property_path: "properties.pricingTier"
        value: "Standard"
    regex_fallback: "Microsoft\\.Security/pricings"
    positive_indicators: ["Microsoft.Security/pricings", "Standard"]
    
  terraform:
    ast_queries:
      - resource_type: "azurerm_security_center_subscription_pricing"
        attribute: "tier"
        value: "Standard"
    regex_fallback: "azurerm_security_center_subscription_pricing"

finding:
  title_template: "Microsoft Defender for Cloud enabled"
  description_template: "Defender for Cloud configured at Standard tier. Verify all workload protection plans are enabled."
  remediation_template: |
    Required Defender plans for FedRAMP:
    - Virtual Machines
    - Storage
    - SQL Databases
    - App Services
    - Key Vault
    - Resource Manager
    - DNS
    - Containers

tags: ["vulnerability-scanning", "defender", "positive"]
nist_controls: ["ra-5", "si-2"]
related_ksis: ["KSI-VDR-01", "KSI-VDR-02"]
azure_services:
  - "Microsoft Defender for Cloud"

---
pattern_id: "vdr.scanning.ci_cd_scanning"
name: "CI/CD Security Scanning"
description: "Detects security scanning in CI/CD pipelines"
family: "VDR"
severity: "HIGH"
pattern_type: "pipeline"

languages:
  github_actions:
    ast_queries:
      - workflow_step: "uses"
        actions:
          - "github/codeql-action"
          - "anchore/scan-action"
          - "aquasecurity/trivy-action"
          - "snyk/actions"
    regex_fallback: "uses:.*codeql|uses:.*trivy|uses:.*snyk"
    positive_indicators: ["codeql", "trivy", "snyk", "aquasec"]
    
  azure_pipelines:
    ast_queries:
      - task_type: "Snyk@1|WhiteSource@21|SonarQube@5"
    regex_fallback: "task:\\s*(Snyk|WhiteSource|SonarQube)"
    
  gitlab_ci:
    ast_queries:
      - job_name: "sast|dependency_scanning|container_scanning"
    regex_fallback: "sast:|dependency_scanning:|container_scanning:"

finding:
  title_template: "Security scanning in CI/CD pipeline"
  description_template: "Automated vulnerability scanning detected in pipeline. Verify scans run on every commit."
  remediation_template: "N/A - Positive finding. Ensure scan results fail builds for HIGH/CRITICAL vulnerabilities."

tags: ["ci-cd", "vulnerability-scanning", "positive"]
nist_controls: ["ra-5", "si-2"]
related_ksis: ["KSI-VDR-01"]

---
pattern_id: "vdr.scanning.missing_sast"
name: "Missing SAST Scanning"
description: "Detects CI/CD pipelines without SAST"
family: "VDR"
severity: "CRITICAL"
pattern_type: "pipeline"

languages:
  github_actions:
    ast_queries:
      - workflow_file: "*.yml"
        conditions:
          - "has_job:build|test"
          - "not_contains:codeql|semgrep|snyk"
    regex_fallback: "on:\\s*(push|pull_request)"
    negative_indicators: ["codeql", "semgrep", "snyk", "sonarqube"]
    
  azure_pipelines:
    ast_queries:
      - pipeline_file: "azure-pipelines.yml"
        conditions:
          - "has_stage:Build"
          - "not_contains_task:Snyk|SonarQube|WhiteSource"
    regex_fallback: "stages:|jobs:"

finding:
  title_template: "No SAST scanning in CI/CD pipeline"
  description_template: "Pipeline lacks Static Application Security Testing. KSI-VDR-01 requires automated code scanning."
  remediation_template: |
    Add SAST to pipeline:
    
    GitHub Actions:
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: python, javascript
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
    
    Azure Pipelines:
    - task: Snyk@1
      inputs:
        serviceConnectionEndpoint: 'Snyk'
        testType: 'code'
        failOnIssues: true

requires_absence: ["vdr.scanning.ci_cd_scanning"]
tags: ["ci-cd", "sast", "critical-gap"]
nist_controls: ["ra-5", "si-2"]
related_ksis: ["KSI-VDR-01"]

---
pattern_id: "vdr.scanning.missing_container_scan"
name: "Missing Container Image Scanning"
description: "Detects container builds without vulnerability scanning"
family: "VDR"
severity: "CRITICAL"
pattern_type: "pipeline"

languages:
  github_actions:
    ast_queries:
      - workflow_step: "uses"
        action: "docker/build-push-action"
        conditions:
          - "not_followed_by:aquasecurity/trivy-action|anchore/scan-action"
    regex_fallback: "docker/build-push-action"
    negative_indicators: ["trivy", "anchore", "snyk container"]
    
  azure_pipelines:
    ast_queries:
      - task_type: "Docker@2"
        conditions:
          - "command:buildAndPush"
          - "not_followed_by:AquaScan|Snyk"
    regex_fallback: "Docker@2.*buildAndPush"

finding:
  title_template: "Container image built without vulnerability scan"
  description_template: "Docker image built without scanning. KSI-VDR-02 requires container vulnerability scanning before deployment."
  remediation_template: |
    Add container scanning:
    
    GitHub Actions:
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'myapp:${{ github.sha }}'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: '1'  # Fail on vulnerabilities

tags: ["container", "vulnerability-scanning", "critical-gap"]
nist_controls: ["ra-5", "si-2"]
related_ksis: ["KSI-VDR-02"]

---
# Patch Management Patterns (KSI-VDR-03)

pattern_id: "vdr.patching.update_management"
name: "Azure Update Management"
description: "Detects Update Management configuration"
family: "VDR"
severity: "INFO"
pattern_type: "resource"

languages:
  bicep:
    ast_queries:
      - resource_type: "Microsoft.Automation/automationAccounts"
        child_resources:
          - "Microsoft.Automation/automationAccounts/softwareUpdateConfigurations"
    regex_fallback: "softwareUpdateConfigurations"
    
  terraform:
    ast_queries:
      - resource_type: "azurerm_automation_software_update_configuration"
    regex_fallback: "azurerm_automation_software_update_configuration"

finding:
  title_template: "Azure Update Management configured"
  description_template: "Automated patching detected. Verify schedules meet FedRAMP timelines (30 days for HIGH, 90 days for MODERATE)."
  remediation_template: "N/A - Positive finding"

tags: ["patching", "update-management", "positive"]
nist_controls: ["si-2"]
related_ksis: ["KSI-VDR-03"]

---
pattern_id: "vdr.patching.outdated_base_image"
name: "Outdated Container Base Image"
description: "Detects old base images in Dockerfiles"
family: "VDR"
severity: "HIGH"
pattern_type: "configuration"

languages:
  dockerfile:
    ast_queries:
      - instruction: "FROM"
        conditions:
          - "not_contains:latest"
          - "not_contains:@sha256"
          - "tag_older_than:90_days"
    regex_fallback: "FROM\\s+[^:]+:[^@\\s]+"
    negative_indicators: ["latest", "@sha256"]

finding:
  title_template: "Outdated container base image"
  description_template: "Base image may contain known vulnerabilities. KSI-VDR-03 requires regular patching (90 days max)."
  remediation_template: |
    Update base image:
    - Use specific version tags, not 'latest'
    - Pin with SHA256 digest for reproducibility
    - Automate base image updates in CI/CD
    - Example: FROM python:3.11-slim@sha256:abc123...

tags: ["container", "patching", "security-gap"]
nist_controls: ["si-2"]
related_ksis: ["KSI-VDR-03"]

---
# Dependency Management Patterns (KSI-VDR-04)

pattern_id: "vdr.dependencies.dependabot"
name: "Dependabot Configuration"
description: "Detects Dependabot for automated dependency updates"
family: "VDR"
severity: "INFO"
pattern_type: "configuration"

languages:
  yaml:
    file_path: ".github/dependabot.yml"
    ast_queries:
      - yaml_path: "updates[*].package-ecosystem"
    regex_fallback: "version:\\s*2"
    positive_indicators: ["dependabot", "package-ecosystem"]

finding:
  title_template: "Dependabot enabled"
  description_template: "Automated dependency updates configured. Verify security updates are enabled."
  remediation_template: "N/A - Positive finding"

tags: ["dependencies", "automation", "positive"]
nist_controls: ["si-2"]
related_ksis: ["KSI-VDR-04"]

---
pattern_id: "vdr.dependencies.outdated_packages"
name: "Outdated Dependencies"
description: "Detects outdated dependencies with known CVEs"
family: "VDR"
severity: "VARIES"
pattern_type: "configuration"

languages:
  python:
    file_path: "requirements.txt|Pipfile|pyproject.toml"
    ast_queries:
      - package_with_cve: true
      - package_age: ">6_months"
    regex_fallback: "^[a-zA-Z0-9_-]+==.*$"
    
  javascript:
    file_path: "package.json"
    ast_queries:
      - json_path: "dependencies.*"
        conditions:
          - "has_known_cve"
    regex_fallback: "\"dependencies\":\\s*\\{"
    
  csharp:
    file_path: "*.csproj|packages.config"
    ast_queries:
      - xml_path: "PackageReference[@Include]"
        conditions:
          - "has_known_cve"
    regex_fallback: "<PackageReference"

finding:
  title_template: "Dependency with known vulnerabilities: {package_name} {version}"
  description_template: "Package {package_name} version {version} has {cve_count} known CVE(s). KSI-VDR-04 requires patching within 30 days."
  remediation_template: "Update to version {fixed_version} or later: pip install {package_name}>={fixed_version}"

tags: ["dependencies", "cve", "security-gap"]
nist_controls: ["si-2", "ra-5"]
related_ksis: ["KSI-VDR-04"]

---
# Secure Development Patterns (KSI-VDR-05)

pattern_id: "vdr.secure_dev.pre_commit_hooks"
name: "Pre-Commit Hooks"
description: "Detects pre-commit hooks for security checks"
family: "VDR"
severity: "INFO"
pattern_type: "configuration"

languages:
  yaml:
    file_path: ".pre-commit-config.yaml"
    ast_queries:
      - yaml_path: "repos[*].hooks[*].id"
        contains: "detect-secrets|bandit|safety"
    regex_fallback: "repos:|hooks:"
    positive_indicators: ["detect-secrets", "bandit", "safety", "gitleaks"]

finding:
  title_template: "Pre-commit security hooks detected"
  description_template: "Security checks run before commits. Verify secret detection and SAST are enabled."
  remediation_template: "N/A - Positive finding"

tags: ["secure-development", "pre-commit", "positive"]
nist_controls: ["sa-11", "si-2"]
related_ksis: ["KSI-VDR-05"]

---
pattern_id: "vdr.secure_dev.code_review_required"
name: "Code Review Required"
description: "Detects branch protection requiring code reviews"
family: "VDR"
severity: "HIGH"
pattern_type: "configuration"

languages:
  github:
    api_check: "branch_protection"
    conditions:
      - "required_approving_review_count:>=1"
      - "dismiss_stale_reviews:true"
    positive_indicators: ["required_pull_request_reviews"]

finding:
  title_template: "Branch protection with code review detected"
  description_template: "Main branch requires code review. Verify at least 1 approval and security-focused reviewers."
  remediation_template: "N/A - Positive finding"

tags: ["secure-development", "code-review", "positive"]
nist_controls: ["sa-11"]
related_ksis: ["KSI-VDR-05"]
