# AFR PATTERNS V2 - V2 Schema
# Migrated from V1 schema with enhanced evidence collection
# 
# NOTE: This is an automated migration. Manual review required for:
# - Evidence collection queries (marked with TODO)
# - Automation implementation code
# - SSP mapping descriptions
# - Test cases

pattern_id: afr.crypto.weak_algorithms
name: Weak or Deprecated Cryptographic Algorithms
description: Detects use of weak cryptographic algorithms (MD5, SHA1, DES, RC4, TLS
  1.0/1.1) that do not meet FedRAMP requirements. KSI-AFR-11 mandates FIPS 140-2/3
  approved algorithms only.
severity: CRITICAL
family: AFR
pattern_type: function_call
ksi_id: KSI-AFR-11
nist_controls:
- sc-13
- sc-17
category: cryptography
languages:
  python:
    ast_queries:
    - node_type: attribute
      pattern: hashlib\.(md5|sha1|md4)
      message: Weak hash algorithm detected - use SHA-256 or stronger
    regex_fallback: (hashlib\.(md5|sha1|md4)|Crypto\.Cipher\.(DES|RC4|ARC4)|ssl\.PROTOCOL_(TLSv1|SSLv[23]))
  csharp:
    regex_fallback: (MD5\.(Create|ComputeHash)|SHA1\.(Create|ComputeHash)|DESCryptoServiceProvider|RC2CryptoServiceProvider|TripleDESCryptoServiceProvider)
  java:
    regex_fallback: (MessageDigest\.getInstance\(["'](MD5|SHA-1|MD4)["']\)|Cipher\.getInstance\(["'](DES|DESede|RC4)["']\))
  typescript:
    regex_fallback: (crypto\.createHash\(["'](md5|sha1)["']\)|crypto\.createCipher\(["'](des|rc4)["']\))
  bicep:
    ast_queries:
    - resource_type: Microsoft.Storage/storageAccounts
      property_path: properties.minimumTlsVersion
      conditions:
      - value_in:['TLS1_0', 'TLS1_1']
    - resource_type: Microsoft.Sql/servers
      property_path: properties.minimalTlsVersion
      conditions:
      - value_in:['1.0', '1.1']
    regex_fallback: (minimumTlsVersion['"]?\s*[:=]\s*['"]?(TLS1_0|TLS1_1)|minimalTlsVersion['"]?\s*[:=]\s*['"]?(1\.0|1\.1))
  terraform:
    regex_fallback: (min_tls_version\s*=\s*["'](1\.0|1\.1)["']|tls_version\s*=\s*["'](TLSv1|TLSv1_0|TLSv1_1)["'])
  github_actions:
    regex_fallback: (uses:.*sslscan.*|uses:.*testssl.*)
remediation: "Replace weak cryptographic algorithms with FIPS 140-2/3 approved alternatives:\n\
  \n**Python:**\n```python\nimport hashlib\nfrom cryptography.hazmat.primitives.ciphers\
  \ import Cipher, algorithms, modes\nfrom cryptography.hazmat.backends import default_backend\n\
  \n# Replace MD5/SHA1 with SHA-256 or stronger\nhash_obj = hashlib.sha256(data.encode())\n\
  digest = hash_obj.hexdigest()\n\n# For password hashing, use bcrypt or Argon2\n\
  from bcrypt import hashpw, gensalt\nhashed_password = hashpw(password.encode(),\
  \ gensalt())\n\n# Replace DES/RC4 with AES-256-GCM\ncipher = Cipher(\n    algorithms.AES(key),\n\
  \    modes.GCM(iv),\n    backend=default_backend()\n)\n\n# Configure TLS 1.2+ only\n\
  import ssl\ncontext = ssl.SSLContext(ssl.PROTOCOL_TLS_CLIENT)\ncontext.minimum_version\
  \ = ssl.TLSVersion.TLSv1_2\n```\n\n**C#:**\n```csharp\nusing System.Security.Cryptography;\n\
  \n// Replace MD5/SHA1 with SHA-256 or stronger\nusing (var sha256 = SHA256.Create())\n\
  {\n    byte[] hash = sha256.ComputeHash(data);\n}\n\n// Replace DES with AES-256\n\
  using (var aes = Aes.Create())\n{\n    aes.KeySize = 256;\n    aes.Mode = CipherMode.GCM;\n\
  \    // ... encryption logic\n}\n\n// Configure TLS 1.2+ in .NET\nServicePointManager.SecurityProtocol\
  \ = SecurityProtocolType.Tls12 | SecurityProtocolType.Tls13;\n```\n\n**Bicep (Azure\
  \ Storage):**\n```bicep\nresource storageAccount 'Microsoft.Storage/storageAccounts@2023-01-01'\
  \ = {\n  name: storageAccountName\n  properties: {\n    minimumTlsVersion: 'TLS1_2'\
  \  // Require TLS 1.2 minimum\n    supportsHttpsTrafficOnly: true\n    encryption:\
  \ {\n      keySource: 'Microsoft.Storage'\n      services: {\n        blob: {\n\
  \          enabled: true\n          keyType: 'Account'\n        }\n      }\n   \
  \ }\n  }\n}\n```\n\n**Terraform (Azure SQL):**\n```hcl\nresource \"azurerm_mssql_server\"\
  \ \"example\" {\n  name                         = \"example-sqlserver\"\n  minimal_tls_version\
  \          = \"1.2\"  # Enforce TLS 1.2+\n  public_network_access_enabled = false\n\
  }\n```\n\n**References:**\n- NIST FIPS 140-3: https://csrc.nist.gov/publications/detail/fips/140/3/final\n\
  - NIST SP 800-52 Rev 2 (TLS): https://csrc.nist.gov/publications/detail/sp/800-52/rev-2/final\n\
  - NIST SP 800-57 Part 1 (Key Management): https://csrc.nist.gov/publications/detail/sp/800-57-part-1/rev-5/final\n\
  - FedRAMP UCM Guidance: https://www.fedramp.gov/using-cryptographic-modules/\n"
finding:
  title: Weak cryptographic algorithm detected
  description: Code uses weak cryptographic algorithms that do not meet FIPS 140-2/3 requirements
  recommendation: Replace with FIPS-approved algorithms (SHA-256+, AES-256, TLS 1.2+)
  references:
  - KSI-AFR-11
  - NIST FIPS 140-3

---
pattern_id: afr.config.debug_mode
name: Debug Mode Enabled in Production
description: Detects debug mode enabled in production environments. KSI-AFR-07 requires
  secure default configurations - debug mode exposes sensitive information and stack
  traces.
severity: HIGH
family: AFR
pattern_type: configuration
ksi_id: KSI-AFR-07
nist_controls:
- cm-6
- si-11
category: configuration
languages:
  python:
    regex_fallback: (debug\s*=\s*True|DEBUG\s*=\s*True|app\.debug\s*=\s*True)
  csharp:
    regex_fallback: (UseDeveloperExceptionPage|DetailedErrors\s*=\s*true)
  java:
    regex_fallback: (spring\.devtools\.enabled=true|logging\.level\.root\s*=\s*DEBUG)
  typescript:
    regex_fallback: (NODE_ENV\s*===?\s*["']development["']|process\.env\.DEBUG)
  bicep:
    ast_queries:
    - resource_type: Microsoft.Web/sites
      property_path: properties.siteConfig.appSettings
      conditions:
      - array_contains:name=ASPNETCORE_ENVIRONMENT,value=Development
    regex_fallback: (name['"]?\s*[:=]\s*['"]ASPNETCORE_ENVIRONMENT['"].*?value['"]?\s*[:=]\s*['"]Development['"]|ASPNETCORE_ENVIRONMENT.*?Development)
  azure_pipelines:
    regex_fallback: (BuildConfiguration.*Debug|dotnet.*--configuration\s+Debug)
remediation: "Disable debug mode in production environments:\n\n**Python (Flask):**\n\
  ```python\nimport os\n\napp = Flask(__name__)\n\n# Use environment variable, default\
  \ to False\napp.config['DEBUG'] = os.getenv('DEBUG', 'False') == 'True'\n\n# Or\
  \ explicitly set based on environment\nif os.getenv('ENVIRONMENT') == 'production':\n\
  \    app.config['DEBUG'] = False\n```\n\n**Python (Django settings.py):**\n```python\n\
  import os\n\nDEBUG = os.getenv('DEBUG', 'False') == 'True'\n\n# Only allow debug\
  \ in development\nif os.getenv('ENVIRONMENT') == 'production':\n    DEBUG = False\n\
  \    ALLOWED_HOSTS = ['yourdomain.com']\n```\n\n**C# (ASP.NET Core Startup.cs):**\n\
  ```csharp\npublic void Configure(IApplicationBuilder app, IWebHostEnvironment env)\n\
  {\n    if (env.IsDevelopment())\n    {\n        app.UseDeveloperExceptionPage();\n\
  \    }\n    else\n    {\n        app.UseExceptionHandler(\"/Error\");\n        app.UseHsts();\n\
  \    }\n}\n```\n\n**Bicep (App Service):**\n```bicep\nresource appService 'Microsoft.Web/sites@2023-01-01'\
  \ = {\n  name: appServiceName\n  properties: {\n    siteConfig: {\n      appSettings:\
  \ [\n        {\n          name: 'ASPNETCORE_ENVIRONMENT'\n          value: 'Production'\
  \  // Use Production, not Development\n        }\n        {\n          name: 'DEBUG'\n\
  \          value: 'false'\n        }\n      ]\n    }\n  }\n}\n```\n\n**Azure Pipelines:**\n\
  ```yaml\n- task: DotNetCoreCLI@2\n  inputs:\n    command: 'build'\n    arguments:\
  \ '--configuration Release'  # Use Release, not Debug\n```\n\n**References:**\n\
  - OWASP: https://owasp.org/www-community/vulnerabilities/Information_exposure_through_debug_information\n\
  - FRR-AFR-07: Recommended Secure Configuration\n"
finding:
  title: Debug mode enabled in production
  description: Application has debug mode enabled which may expose sensitive information
  recommendation: Disable debug mode in production environments
  references:
  - KSI-AFR-07
  - FRR-AFR-07

---
pattern_id: afr.scanning.missing_vulnerability_scan
name: Missing Vulnerability Scanning Configuration
description: Detects missing vulnerability scanning (SAST, dependency scanning, container
  scanning) in CI/CD pipelines. KSI-AFR-04 requires comprehensive vulnerability detection
  per FedRAMP VDR process.
severity: HIGH
family: AFR
pattern_type: pipeline
ksi_id: KSI-AFR-04
nist_controls:
- ra-5
- sa-11
category: vulnerability_detection
languages:
  github_actions:
    regex_fallback: (uses:.*security-scan|uses:.*trivy|uses:.*codeql|uses:.*dependency-review)
  azure_pipelines:
    regex_fallback: (task:\s*WhiteSource|task:\s*CredScan|task:\s*Trivy|task:\s*SecurityCodeScan)
  gitlab_ci:
    regex_fallback: (include:.*Security/SAST|include:.*Security/Dependency-Scanning|include:.*Security/Container-Scanning)
  bicep:
    ast_queries:
    - resource_type: Microsoft.Security/pricings
      property_path: properties.pricingTier
      conditions:
      - value_equals:'Standard'
    regex_fallback: (Microsoft\.Security/pricings.*?pricingTier['"]?\s*[:=]\s*['"]?Standard)
  terraform:
    regex_fallback: (resource\s+"azurerm_security_center_subscription_pricing")
remediation: "Implement comprehensive vulnerability scanning in CI/CD pipelines:\n\
  \n**GitHub Actions (.github/workflows/security.yml):**\n```yaml\nname: Security\
  \ Scanning\n\non: [push, pull_request]\n\njobs:\n  sast:\n    runs-on: ubuntu-latest\n\
  \    steps:\n      - uses: actions/checkout@v4\n      \n      # SAST: CodeQL for\
  \ static analysis\n      - uses: github/codeql-action/init@v3\n        with:\n \
  \         languages: 'python, javascript'\n      - uses: github/codeql-action/analyze@v3\n\
  \      \n      # Dependency scanning\n      - uses: actions/dependency-review-action@v4\n\
  \      \n      # Container scanning with Trivy\n      - uses: aquasecurity/trivy-action@master\n\
  \        with:\n          scan-type: 'fs'\n          scan-ref: '.'\n          format:\
  \ 'sarif'\n          output: 'trivy-results.sarif'\n      \n      # Upload results\
  \ to Security tab\n      - uses: github/codeql-action/upload-sarif@v3\n        with:\n\
  \          sarif_file: 'trivy-results.sarif'\n```\n\n**Azure Pipelines (azure-pipelines.yml):**\n\
  ```yaml\ntrigger:\n  - main\n\njobs:\n- job: SecurityScanning\n  pool:\n    vmImage:\
  \ 'ubuntu-latest'\n  steps:\n    # SAST with Security Code Scan\n    - task: SecurityCodeScan@1\n\
  \      inputs:\n        targetDirectory: '$(Build.SourcesDirectory)'\n    \n   \
  \ # Dependency scanning with WhiteSource Bolt\n    - task: WhiteSource@21\n    \
  \  inputs:\n        cwd: '$(Build.SourcesDirectory)'\n    \n    # Container scanning\
  \ with Trivy\n    - task: CmdLine@2\n      inputs:\n        script: |\n        \
  \  wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key\
  \ add -\n          echo \"deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release\
  \ -sc) main\" | sudo tee -a /etc/apt/sources.list.d/trivy.list\n          sudo apt-get\
  \ update\n          sudo apt-get install trivy\n          trivy fs --severity HIGH,CRITICAL\
  \ .\n```\n\n**Bicep (Enable Microsoft Defender for Cloud):**\n```bicep\n// Enable\
  \ Defender for Servers\nresource defenderServers 'Microsoft.Security/pricings@2024-01-01'\
  \ = {\n  name: 'VirtualMachines'\n  properties: {\n    pricingTier: 'Standard' \
  \ // Enable advanced threat protection\n  }\n}\n\n// Enable Defender for Containers\n\
  resource defenderContainers 'Microsoft.Security/pricings@2024-01-01' = {\n  name:\
  \ 'Containers'\n  properties: {\n    pricingTier: 'Standard'\n  }\n}\n\n// Enable\
  \ Defender for App Service\nresource defenderAppService 'Microsoft.Security/pricings@2024-01-01'\
  \ = {\n  name: 'AppServices'\n  properties: {\n    pricingTier: 'Standard'\n  }\n\
  }\n```\n\n**Terraform (Enable Defender for Cloud):**\n```hcl\n# Enable Defender\
  \ for Servers\nresource \"azurerm_security_center_subscription_pricing\" \"servers\"\
  \ {\n  tier          = \"Standard\"\n  resource_type = \"VirtualMachines\"\n}\n\n\
  # Enable Defender for Containers\nresource \"azurerm_security_center_subscription_pricing\"\
  \ \"containers\" {\n  tier          = \"Standard\"\n  resource_type = \"Containers\"\
  \n}\n\n# Enable Defender for App Service\nresource \"azurerm_security_center_subscription_pricing\"\
  \ \"app_service\" {\n  tier          = \"Standard\"\n  resource_type = \"AppServices\"\
  \n}\n```\n\n**Scanning Frequency:**\n- Daily automated scans (CI/CD integration)\n\
  - Weekly scheduled full scans (GitHub security tab, Azure Security Center)\n- Monthly\
  \ compliance reports\n\n**References:**\n- FedRAMP VDR Process: https://www.fedramp.gov/vulnerability-detection-and-response/\n\
  - NIST SP 800-53 RA-5: https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final\n\
  - Microsoft Defender for Cloud: https://learn.microsoft.com/en-us/azure/defender-for-cloud/\n"
finding:
  title: Missing vulnerability scanning configuration
  description: No vulnerability scanning detected in CI/CD pipeline or IaC
  recommendation: Implement SAST, dependency scanning, and container scanning
  references:
  - KSI-AFR-04
  - FRR-VDR-01

---
pattern_id: afr.config.insecure_defaults
name: Insecure Default Configurations Detected
description: Detects insecure default configurations such as public network access
  enabled, HTTPS not required, or missing encryption. KSI-AFR-07 requires secure-by-default
  configurations.
severity: HIGH
family: AFR
pattern_type: resource
ksi_id: KSI-AFR-07
nist_controls:
- cm-6
- sc-8
category: configuration
languages:
  bicep:
    ast_queries:
    - resource_type: Microsoft.Storage/storageAccounts
      property_path: properties.supportsHttpsTrafficOnly
      conditions:
      - value_equals:false
      - property_missing
    - resource_type: Microsoft.Sql/servers
      property_path: properties.publicNetworkAccess
      conditions:
      - value_equals:'Enabled'
    - resource_type: Microsoft.KeyVault/vaults
      property_path: properties.enableSoftDelete
      conditions:
      - value_equals:false
      - property_missing
    regex_fallback: (supportsHttpsTrafficOnly['"]?\s*[:=]\s*false|publicNetworkAccess['"]?\s*[:=]\s*['"]?Enabled|enableSoftDelete['"]?\s*[:=]\s*false)
  terraform:
    ast_queries:
    - resource_type: azurerm_storage_account
      property_path: enable_https_traffic_only
      conditions:
      - value_equals:false
      - property_missing
    - resource_type: azurerm_mssql_server
      property_path: public_network_access_enabled
      conditions:
      - value_equals:true
    regex_fallback: (enable_https_traffic_only\s*=\s*false|public_network_access_enabled\s*=\s*true)
remediation: "Configure secure defaults for all Azure resources:\n\n**Bicep (Storage\
  \ Account - Secure Defaults):**\n```bicep\nresource storageAccount 'Microsoft.Storage/storageAccounts@2023-01-01'\
  \ = {\n  name: storageAccountName\n  location: location\n  sku: {\n    name: 'Standard_GRS'\
  \  // Geo-redundant for DR\n  }\n  kind: 'StorageV2'\n  properties: {\n    // CRITICAL:\
  \ Enforce HTTPS only\n    supportsHttpsTrafficOnly: true\n    \n    // Enforce TLS\
  \ 1.2 minimum\n    minimumTlsVersion: 'TLS1_2'\n    \n    // Disable public blob\
  \ access\n    allowBlobPublicAccess: false\n    \n    // Enable infrastructure encryption\n\
  \    encryption: {\n      keySource: 'Microsoft.Storage'\n      requireInfrastructureEncryption:\
  \ true\n      services: {\n        blob: {\n          enabled: true\n          keyType:\
  \ 'Account'\n        }\n        file: {\n          enabled: true\n          keyType:\
  \ 'Account'\n        }\n      }\n    }\n    \n    // Network restrictions\n    networkAcls:\
  \ {\n      defaultAction: 'Deny'\n      bypass: 'AzureServices'\n    }\n  }\n}\n\
  ```\n\n**Bicep (SQL Server - Secure Defaults):**\n```bicep\nresource sqlServer 'Microsoft.Sql/servers@2023-05-01-preview'\
  \ = {\n  name: sqlServerName\n  location: location\n  properties: {\n    // Disable\
  \ public network access\n    publicNetworkAccess: 'Disabled'\n    \n    // Enforce\
  \ TLS 1.2+\n    minimalTlsVersion: '1.2'\n    \n    // Use Azure AD authentication\n\
  \    administrators: {\n      azureADOnlyAuthentication: true\n      principalType:\
  \ 'Group'\n      login: 'SQL Administrators'\n      sid: sqlAdminGroupObjectId\n\
  \    }\n  }\n}\n```\n\n**Bicep (Key Vault - Secure Defaults):**\n```bicep\nresource\
  \ keyVault 'Microsoft.KeyVault/vaults@2023-07-01' = {\n  name: keyVaultName\n  location:\
  \ location\n  properties: {\n    // Enable soft delete (required for production)\n\
  \    enableSoftDelete: true\n    softDeleteRetentionInDays: 90\n    \n    // Enable\
  \ purge protection\n    enablePurgeProtection: true\n    \n    // Disable public\
  \ network access\n    publicNetworkAccess: 'Disabled'\n    \n    // Enable RBAC\n\
  \    enableRbacAuthorization: true\n    \n    // Network restrictions\n    networkAcls:\
  \ {\n      defaultAction: 'Deny'\n      bypass: 'AzureServices'\n    }\n  }\n}\n\
  ```\n\n**Terraform (Storage Account - Secure Defaults):**\n```hcl\nresource \"azurerm_storage_account\"\
  \ \"example\" {\n  name                      = \"examplestorageacct\"\n  resource_group_name\
  \       = azurerm_resource_group.example.name\n  location                  = azurerm_resource_group.example.location\n\
  \  account_tier              = \"Standard\"\n  account_replication_type  = \"GRS\"\
  \  # Geo-redundant\n  \n  # CRITICAL: Enforce HTTPS only\n  enable_https_traffic_only\
  \ = true\n  \n  # Enforce TLS 1.2 minimum\n  min_tls_version = \"TLS1_2\"\n  \n\
  \  # Disable public blob access\n  allow_nested_items_to_be_public = false\n  \n\
  \  # Enable infrastructure encryption\n  infrastructure_encryption_enabled = true\n\
  \  \n  # Network restrictions\n  network_rules {\n    default_action = \"Deny\"\n\
  \    bypass         = [\"AzureServices\"]\n  }\n}\n```\n\n**References:**\n- Azure\
  \ Security Baseline: https://learn.microsoft.com/en-us/security/benchmark/azure/\n\
  - CIS Azure Foundations Benchmark: https://www.cisecurity.org/benchmark/azure\n\
  - FRR-AFR-07: Recommended Secure Configuration\n"
finding:
  title: Insecure default configuration detected
  description: Resource configured with insecure defaults (public access, HTTP allowed, etc.)
  recommendation: Enable secure defaults per Azure Security Baseline
  references:
  - KSI-AFR-07
  - FRR-AFR-07
