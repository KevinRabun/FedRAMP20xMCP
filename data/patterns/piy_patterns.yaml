# PIY (Privacy) Pattern Library

# PII Detection in Logs and Storage (KSI-PIY-01)

---
pattern_id: "piy.pii.logging_detection"
name: "PII in Logging Statements"
description: "Detects potential PII being logged (KSI-PIY-01: Privacy Protection)"
family: "PIY"
severity: "CRITICAL"
pattern_type: "code_pattern"

languages:
  python:
    ast_queries:
      - query_type: "function_call"
        target: "logger.info|logger.debug|logger.warning|logger.error|print"
        conditions:
          - "arg_contains:ssn|social_security|credit_card|email|phone|address|birthdate|password"
    regex_fallback: "(logger\\.(info|debug|warning|error)|print)\\([^)]*\\b(ssn|social_security|social security number|credit_card|creditcard|email|phone|telephone|address|birthdate|birth date|date of birth|dob|password|passwd)\\b"
    
  csharp:
    ast_queries:
      - query_type: "method_call"
        target: "Log|WriteLine|Debug|Info|Warn|Error"
        conditions:
          - "arg_contains:ssn|socialSecurity|creditCard|email|phone|address|birthDate|password"
    regex_fallback: "(Log|WriteLine|Debug|Info|Warn|Error)\\([^)]*\\b(ssn|social.?security|credit.?card|email|phone|address|birth.?date|password)\\b"
    
  java:
    ast_queries:
      - query_type: "method_call"
        target: "log|println|debug|info|warn|error"
        conditions:
          - "arg_contains:ssn|socialSecurity|creditCard|email|phone|address|birthDate|password"
    regex_fallback: "(log|println|debug|info|warn|error)\\([^)]*\\b(ssn|socialSecurity|creditCard|email|phone|address|birthDate|password)\\b"
    
  typescript:
    ast_queries:
      - query_type: "function_call"
        target: "console.log|console.debug|console.info|console.warn|console.error|logger.log"
        conditions:
          - "arg_contains:ssn|socialSecurity|creditCard|email|phone|address|birthDate|password"
    regex_fallback: "(console\\.(log|debug|info|warn|error)|logger\\.log)\\([^)]*\\b(ssn|social.?security|credit.?card|email|phone|address|birth.?date|password)\\b"

finding:
  title_template: "Potential PII in logging statement"
  description_template: "Logging statement may contain Personally Identifiable Information (PII). KSI-PIY-01 requires PII to be masked or excluded from logs."
  remediation_template: |
    Remove or mask PII in logs:
    
    Python (Masking PII):
    import re
    
    def mask_pii(text: str) -> str:
        """Mask PII in log messages"""
        # Mask SSN (XXX-XX-1234)
        text = re.sub(r'\b\d{3}-\d{2}-(\d{4})\b', r'XXX-XX-\1', text)
        
        # Mask credit card (XXXX-XXXX-XXXX-1234)
        text = re.sub(r'\b(\d{4}[-\s]?\d{4}[-\s]?\d{4}[-\s]?)(\d{4})\b', r'XXXX-XXXX-XXXX-\2', text)
        
        # Mask email (us**@example.com)
        text = re.sub(r'\b([a-zA-Z0-9._%+-]{2})[a-zA-Z0-9._%+-]*@', r'\1**@', text)
        
        # Mask phone ((XXX) XXX-1234)
        text = re.sub(r'\b(\+?1[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?(\d{4})\b', r'(XXX) XXX-\2', text)
        
        return text
    
    # Use structured logging with PII exclusion
    logger.info(
        "User operation completed",
        extra={
            'user_id': user_id,  # OK: Non-PII identifier
            'operation': operation,
            # DO NOT LOG: user.email, user.ssn, user.phone
        }
    )
    
    # If PII must be logged (debugging only), mask it
    logger.debug(f"User email: {mask_pii(user.email)}")
    
    C# (Masking PII):
    using System.Text.RegularExpressions;
    
    public static string MaskPii(string text)
    {
        // Mask SSN
        text = Regex.Replace(text, @"\b\d{3}-\d{2}-(\d{4})\b", "XXX-XX-$1");
        
        // Mask credit card
        text = Regex.Replace(text, @"\b(\d{4}[-\s]?\d{4}[-\s]?\d{4}[-\s]?)(\d{4})\b", "XXXX-XXXX-XXXX-$2");
        
        // Mask email
        text = Regex.Replace(text, @"\b([a-zA-Z0-9._%+-]{2})[a-zA-Z0-9._%+-]*@", "$1**@");
        
        return text;
    }
    
    // Structured logging without PII
    _logger.LogInformation(
        "User operation: {Operation} for user {UserId}",
        operation,
        userId  // OK: Non-PII identifier
        // DO NOT LOG: user.Email, user.SSN, user.Phone
    );
    
    Best Practices:
    1. **Never log**: SSN, credit card numbers, passwords, full emails, phone numbers
    2. **Use identifiers**: Log user_id, session_id, transaction_id instead
    3. **Mask if necessary**: Last 4 digits only, partial emails (us**@example.com)
    4. **Structured logging**: Use key-value pairs, exclude PII fields
    5. **Log retention**: Apply shorter retention for logs with masked PII
  evidence_collection:
    - "Code review showing PII masking implementation"
    - "Logging configuration excluding PII fields"
    - "Sample logs demonstrating PII masking"
    - "Developer training documentation on PII handling"
  azure_services:
    - "Azure Monitor"
    - "Application Insights"
    - "Azure Purview"

tags: ["pii", "privacy", "data-protection", "critical-gap"]
nist_controls: ["ar-4", "ar-5", "pt-2", "pt-3", "si-12"]
related_ksis: ["KSI-PIY-01"]

---
pattern_id: "piy.retention.missing_policy"
name: "Missing Data Retention Policy"
description: "Detects missing data retention configuration (KSI-PIY-02: Data Retention)"
family: "PIY"
severity: "HIGH"
pattern_type: "resource_configuration"

languages:
  bicep:
    ast_queries:
      - resource_type: "Microsoft.Storage/storageAccounts/blobServices"
        conditions:
          - "not_has_property:deleteRetentionPolicy"
      - resource_type: "Microsoft.OperationalInsights/workspaces"
        property_path: "properties.retentionInDays"
        conditions:
          - "value_less_than:90"
          - "property_missing"
      - resource_type: "Microsoft.Sql/servers/databases"
        conditions:
          - "not_has_property:longTermRetentionPolicy"
    regex_fallback: "(Microsoft\\.Storage/storageAccounts/blobServices)(?!.*deleteRetentionPolicy)|(Microsoft\\.OperationalInsights/workspaces)(?!.*retentionInDays)|(Microsoft\\.Sql/servers/databases)(?!.*longTermRetentionPolicy)"
    
  terraform:
    ast_queries:
      - resource_type: "azurerm_storage_account"
        conditions:
          - "not_has_block:blob_properties.delete_retention_policy"
      - resource_type: "azurerm_log_analytics_workspace"
        property_path: "retention_in_days"
        conditions:
          - "value_less_than:90"
          - "property_missing"
    regex_fallback: "resource\\s+\"azurerm_storage_account\"(?!.*delete_retention_policy)|resource\\s+\"azurerm_log_analytics_workspace\"(?!.*retention_in_days)"

finding:
  title_template: "Resource lacks data retention policy"
  description_template: "{resource_type} does not have data retention policy configured. KSI-PIY-02 requires documented retention periods per data classification."
  remediation_template: |
    Configure data retention policies:
    
    Bicep (Storage Account Retention):
    resource storageAccount 'Microsoft.Storage/storageAccounts@2023-01-01' = {
      name: storageAccountName
      location: location
      sku: {
        name: 'Standard_LRS'
      }
      kind: 'StorageV2'
    }
    
    resource blobServices 'Microsoft.Storage/storageAccounts/blobServices@2023-01-01' = {
      parent: storageAccount
      name: 'default'
      properties: {
        deleteRetentionPolicy: {
          enabled: true
          days: 30  // 30-day soft delete (FedRAMP minimum)
        }
        containerDeleteRetentionPolicy: {
          enabled: true
          days: 30
        }
        changeFeed: {
          enabled: true
          retentionInDays: 90  // 90-day change feed retention
        }
      }
    }
    
    // Lifecycle management for automated deletion
    resource lifecyclePolicy 'Microsoft.Storage/storageAccounts/managementPolicies@2023-01-01' = {
      parent: storageAccount
      name: 'default'
      properties: {
        policy: {
          rules: [
            {
              name: 'DeleteOldLogs'
              enabled: true
              type: 'Lifecycle'
              definition: {
                filters: {
                  blobTypes: ['blockBlob']
                  prefixMatch: ['logs/']
                }
                actions: {
                  baseBlob: {
                    delete: {
                      daysAfterModificationGreaterThan: 2555  // 7 years (FedRAMP)
                    }
                  }
                }
              }
            }
            {
              name: 'DeleteOldBackups'
              enabled: true
              type: 'Lifecycle'
              definition: {
                filters: {
                  blobTypes: ['blockBlob']
                  prefixMatch: ['backups/']
                }
                actions: {
                  baseBlob: {
                    delete: {
                      daysAfterModificationGreaterThan: 2555  // 7 years
                    }
                  }
                }
              }
            }
          ]
        }
      }
    }
    
    Bicep (Log Analytics Retention):
    resource logAnalytics 'Microsoft.OperationalInsights/workspaces@2022-10-01' = {
      name: workspaceName
      location: location
      properties: {
        sku: {
          name: 'PerGB2018'
        }
        retentionInDays: 90  // 90-day minimum (FedRAMP), can be up to 730
        features: {
          enableDataExport: true
        }
      }
    }
    
    Terraform:
    resource "azurerm_storage_account" "main" {
      name                     = "mystorageaccount"
      resource_group_name      = azurerm_resource_group.main.name
      location                 = azurerm_resource_group.main.location
      account_tier             = "Standard"
      account_replication_type = "GRS"
      
      blob_properties {
        delete_retention_policy {
          days = 30  # 30-day soft delete
        }
        
        container_delete_retention_policy {
          days = 30
        }
      }
    }
    
    resource "azurerm_storage_management_policy" "main" {
      storage_account_id = azurerm_storage_account.main.id
      
      rule {
        name    = "DeleteOldLogs"
        enabled = true
        
        filters {
          prefix_match = ["logs/"]
          blob_types   = ["blockBlob"]
        }
        
        actions {
          base_blob {
            delete_after_days_since_modification_greater_than = 2555  # 7 years
          }
        }
      }
    }
    
    resource "azurerm_log_analytics_workspace" "main" {
      name                = "myworkspace"
      location            = azurerm_resource_group.main.location
      resource_group_name = azurerm_resource_group.main.name
      sku                 = "PerGB2018"
      retention_in_days   = 90  # 90-day minimum
    }
    
    FedRAMP Data Retention Requirements:
    
    **By Data Type:**
    - **Audit logs**: 90 days minimum (online), 7 years (archive)
    - **Security logs**: 90 days minimum (online), 7 years (archive)
    - **Backups**: 7 years minimum
    - **User data**: Per data classification and business requirements
    - **System logs**: 30 days minimum
    
    **By Classification:**
    - **High sensitivity** (PII, PHI): 7 years + legal hold capability
    - **Medium sensitivity**: 3-5 years typical
    - **Low sensitivity**: 1-3 years typical
    - **Temporary data**: Delete within 30-90 days
    
    **Required Capabilities:**
    1. Soft delete (30 days minimum)
    2. Lifecycle management policies
    3. Immutable storage for audit logs
    4. Legal hold capability
    5. Documented retention schedule by data type
  evidence_collection:
    - "Data retention policy document with retention periods"
    - "Data classification matrix"
    - "Storage/database retention configuration"
    - "Lifecycle management policies"
    - "Legal hold procedures"
  azure_services:
    - "Azure Storage"
    - "Azure Backup"
    - "Azure Log Analytics"
    - "Azure Purview"

tags: ["data-retention", "privacy", "compliance", "security-gap"]
nist_controls: ["si-12", "au-11", "mp-6"]
related_ksis: ["KSI-PIY-02"]
