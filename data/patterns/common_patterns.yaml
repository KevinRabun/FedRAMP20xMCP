# Common Patterns Library
# Cross-cutting patterns used across multiple families

# Azure Resource Tagging

---
pattern_id: "common.tagging.required_tags"
name: "Required Azure Resource Tags"
description: "Detects missing required tags for FedRAMP compliance"
family: "COMMON"
severity: "MEDIUM"
pattern_type: "resource"

languages:
  bicep:
    ast_queries:
      - resource_type: "*"
        property_path: "tags"
        conditions:
          - "not_contains_key:Environment"
          - "not_contains_key:Owner"
          - "not_contains_key:CostCenter"
    regex_fallback: "resource\\s+\\w+\\s+'[^']+'"
    
  terraform:
    ast_queries:
      - resource_type: "azurerm_*"
        attribute: "tags"
        conditions:
          - "not_contains_key:Environment"
          - "not_contains_key:Owner"
    regex_fallback: "resource\\s+\"azurerm_"

finding:
  title_template: "Missing required resource tags"
  description_template: "Resource lacks required tags for governance and cost tracking."
  remediation_template: |
    Add required tags:
    tags: {
      Environment: 'Production'  // or Dev, Test, Staging
      Owner: 'security-team@example.com'
      CostCenter: 'CC-12345'
      DataClassification: 'Confidential'
      ComplianceScope: 'FedRAMP-High'
    }

tags: ["governance", "tagging", "compliance"]
nist_controls: ["cm-8"]
related_ksis: ["KSI-FSI-01"]

---
# Diagnostic Settings

pattern_id: "common.diagnostics.missing_diagnostic_settings"
name: "Missing Diagnostic Settings"
description: "Detects resources without diagnostic log export"
family: "COMMON"
severity: "HIGH"
pattern_type: "configuration"

languages:
  bicep:
    ast_queries:
      - resource_type: "Microsoft.Storage/*|Microsoft.Sql/*|Microsoft.KeyVault/*|Microsoft.Compute/*|Microsoft.Network/*"
        conditions:
          - "not_has_child_resource:Microsoft.Insights/diagnosticSettings"
    regex_fallback: "resource\\s+\\w+\\s+'Microsoft\\.(Storage|Sql|KeyVault|Compute|Network)"
    
  terraform:
    ast_queries:
      - resource_type: "azurerm_storage_account|azurerm_sql_server|azurerm_key_vault|azurerm_virtual_machine|azurerm_network_interface"
        conditions:
          - "not_has_companion_resource:azurerm_monitor_diagnostic_setting"
    regex_fallback: "resource\\s+\"azurerm_(storage_account|sql_server|key_vault)\""

finding:
  title_template: "Diagnostic settings not configured"
  description_template: "Resource does not export logs to Log Analytics. Required for audit and security monitoring."
  remediation_template: |
    Add diagnostic settings:
    
    Bicep:
    resource diagnostics 'Microsoft.Insights/diagnosticSettings@2021-05-01-preview' = {
      scope: myResource
      name: 'logs-to-workspace'
      properties: {
        workspaceId: logAnalyticsWorkspace.id
        logs: [
          {
            categoryGroup: 'allLogs'
            enabled: true
          }
        ]
        metrics: [
          {
            category: 'AllMetrics'
            enabled: true
          }
        ]
      }
    }

tags: ["diagnostics", "logging", "audit"]
nist_controls: ["au-2", "au-3", "au-12"]
related_ksis: ["KSI-MLA-01", "KSI-MLA-09"]

---
# Managed Identity

pattern_id: "common.identity.managed_identity"
name: "Managed Identity Usage"
description: "Detects use of managed identity for authentication"
family: "COMMON"
severity: "INFO"
pattern_type: "configuration"

languages:
  bicep:
    ast_queries:
      - resource_type: "*"
        property_path: "identity.type"
        value: "SystemAssigned|UserAssigned"
    regex_fallback: "identity:\\s*\\{"
    positive_indicators: ["SystemAssigned", "UserAssigned"]
    
  terraform:
    ast_queries:
      - resource_type: "azurerm_*"
        has_block: "identity"
    regex_fallback: "identity\\s*\\{"
    
  python:
    ast_queries:
      - query_type: "import_statement"
        target: "azure.identity.DefaultAzureCredential"
    regex_fallback: "from\\s+azure\\.identity\\s+import\\s+DefaultAzureCredential"
    
  csharp:
    ast_queries:
      - query_type: "using_directive"
        target: "Azure.Identity"
    regex_fallback: "using\\s+Azure\\.Identity"

finding:
  title_template: "Managed identity detected"
  description_template: "Resource uses managed identity for passwordless authentication. Positive security pattern."
  remediation_template: "N/A - Positive finding"

tags: ["identity", "managed-identity", "positive"]
nist_controls: ["ia-2", "ia-5"]
related_ksis: ["KSI-IAM-01", "KSI-SVC-02"]

---
# Public Network Access

pattern_id: "common.network.public_access_enabled"
name: "Public Network Access Enabled"
description: "Detects resources with public network access"
family: "COMMON"
severity: "HIGH"
pattern_type: "configuration"

languages:
  bicep:
    ast_queries:
      - resource_type: "Microsoft.Storage/*|Microsoft.Sql/*|Microsoft.KeyVault/*"
        property_path: "properties.publicNetworkAccess"
        value: "Enabled"
    regex_fallback: "publicNetworkAccess.*Enabled"
    negative_indicators: ["publicNetworkAccess: 'Enabled'"]
    
  terraform:
    ast_queries:
      - resource_type: "azurerm_storage_account|azurerm_sql_server|azurerm_key_vault"
        attribute: "public_network_access_enabled"
        value: true
    regex_fallback: "public_network_access_enabled.*=.*true"

finding:
  title_template: "Public network access enabled"
  description_template: "Resource allows public internet access. FedRAMP recommends private endpoints for data-tier resources."
  remediation_template: |
    Disable public access and add private endpoint:
    
    Bicep:
    properties: {
      publicNetworkAccess: 'Disabled'
    }
    
    resource privateEndpoint 'Microsoft.Network/privateEndpoints@2021-05-01' = {
      name: '${resourceName}-pe'
      location: location
      properties: {
        subnet: {
          id: subnetId
        }
        privateLinkServiceConnections: [
          {
            name: '${resourceName}-connection'
            properties: {
              privateLinkServiceId: resource.id
              groupIds: ['blob']  // or 'sqlServer', 'vault', etc.
            }
          }
        ]
      }
    }

tags: ["network", "public-access", "security-gap"]
nist_controls: ["sc-7", "ac-4"]
related_ksis: ["KSI-SVC-06", "KSI-CNA-01"]

---
# Azure Policy Assignments

pattern_id: "common.governance.azure_policy"
name: "Azure Policy Assignment"
description: "Detects Azure Policy assignments for compliance"
family: "COMMON"
severity: "INFO"
pattern_type: "resource"

languages:
  bicep:
    ast_queries:
      - resource_type: "Microsoft.Authorization/policyAssignments"
    regex_fallback: "Microsoft\\.Authorization/policyAssignments"
    positive_indicators: ["policyAssignments"]
    
  terraform:
    ast_queries:
      - resource_type: "azurerm_policy_assignment|azurerm_subscription_policy_assignment"
    regex_fallback: "azurerm_.*policy_assignment"

finding:
  title_template: "Azure Policy assignment detected"
  description_template: "Policy-based governance enabled. Verify FedRAMP baseline policies are assigned."
  remediation_template: |
    Recommended policy initiatives for FedRAMP:
    - Azure Security Benchmark
    - NIST SP 800-53 Rev. 5
    - FedRAMP High
    - ISO 27001
    
    Example assignment:
    resource policyAssignment 'Microsoft.Authorization/policyAssignments@2021-06-01' = {
      name: 'fedramp-high-compliance'
      properties: {
        policyDefinitionId: '/providers/Microsoft.Authorization/policySetDefinitions/...'
        parameters: {...}
      }
    }

tags: ["governance", "policy", "positive"]
nist_controls: ["cm-2", "cm-7"]
related_ksis: ["KSI-FSI-01", "KSI-CCM-01"]

---
# Resource Locks

pattern_id: "common.governance.resource_lock"
name: "Resource Lock"
description: "Detects resource locks for change protection"
family: "COMMON"
severity: "INFO"
pattern_type: "resource"

languages:
  bicep:
    ast_queries:
      - resource_type: "Microsoft.Authorization/locks"
        property_path: "properties.level"
        value: "CanNotDelete|ReadOnly"
    regex_fallback: "Microsoft\\.Authorization/locks"
    positive_indicators: ["CanNotDelete", "ReadOnly"]
    
  terraform:
    ast_queries:
      - resource_type: "azurerm_management_lock"
    regex_fallback: "azurerm_management_lock"

finding:
  title_template: "Resource lock detected"
  description_template: "Resource has delete or read-only lock. Protects against accidental changes."
  remediation_template: "N/A - Positive finding"

tags: ["governance", "change-control", "positive"]
nist_controls: ["cm-3", "cm-5"]
related_ksis: ["KSI-CCM-01"]

---
# Backup Configuration

pattern_id: "common.resilience.backup_missing"
name: "Missing Backup Configuration"
description: "Detects resources without backup enabled"
family: "COMMON"
severity: "HIGH"
pattern_type: "configuration"

languages:
  bicep:
    ast_queries:
      - resource_type: "Microsoft.Compute/virtualMachines|Microsoft.Sql/servers/databases"
        conditions:
          - "not_has_related_resource:Microsoft.RecoveryServices/vaults"
    regex_fallback: "Microsoft\\.(Compute/virtualMachines|Sql/servers/databases)"
    
  terraform:
    ast_queries:
      - resource_type: "azurerm_virtual_machine|azurerm_mssql_database"
        conditions:
          - "not_has_companion_resource:azurerm_backup_protected_vm|azurerm_backup_policy"
    regex_fallback: "azurerm_(virtual_machine|mssql_database)"

finding:
  title_template: "Backup not configured"
  description_template: "Resource does not have backup enabled. FedRAMP requires backup for data availability and resilience."
  remediation_template: |
    Configure Azure Backup:
    
    Bicep:
    resource backupVault 'Microsoft.RecoveryServices/vaults@2021-12-01' = {
      name: 'backup-vault'
      location: location
      sku: {
        name: 'Standard'
      }
      properties: {}
    }
    
    resource backupPolicy 'Microsoft.RecoveryServices/vaults/backupPolicies@2021-12-01' = {
      parent: backupVault
      name: 'daily-backup'
      properties: {
        backupManagementType: 'AzureIaasVM'
        schedulePolicy: {
          scheduleRunFrequency: 'Daily'
          scheduleRunTimes: ['2023-01-01T02:00:00Z']
        }
        retentionPolicy: {
          dailySchedule: {
            retentionDuration: {
              count: 30
              durationType: 'Days'
            }
          }
        }
      }
    }

tags: ["resilience", "backup", "security-gap"]
nist_controls: ["cp-9", "cp-10"]
related_ksis: ["KSI-RPL-01", "KSI-RPL-02"]

---
# Geo-Redundancy

pattern_id: "common.resilience.geo_redundancy"
name: "Geo-Redundant Storage"
description: "Detects geo-redundancy configuration"
family: "COMMON"
severity: "INFO"
pattern_type: "configuration"

languages:
  bicep:
    ast_queries:
      - resource_type: "Microsoft.Storage/storageAccounts"
        property_path: "sku.name"
        value: "Standard_GRS|Standard_RAGRS|Standard_GZRS"
    regex_fallback: "sku:\\s*\\{.*name:\\s*'Standard_(GRS|RAGRS|GZRS)'"
    positive_indicators: ["GRS", "RAGRS", "GZRS"]
    
  terraform:
    ast_queries:
      - resource_type: "azurerm_storage_account"
        attribute: "account_replication_type"
        value: "GRS|RAGRS|GZRS"
    regex_fallback: "account_replication_type.*=.*\"(GRS|RAGRS|GZRS)\""

finding:
  title_template: "Geo-redundant storage configured"
  description_template: "Storage has geo-redundancy for disaster recovery. Verify RPO/RTO meet FedRAMP requirements."
  remediation_template: "N/A - Positive finding"

tags: ["resilience", "geo-redundancy", "positive"]
nist_controls: ["cp-6", "cp-9"]
related_ksis: ["KSI-RPL-01", "KSI-RPL-02"]
