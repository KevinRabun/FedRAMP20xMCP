# UCM (User Capability Management) Patterns for FedRAMP 20x Compliance
# Family: UCM - User Capability Management Requirements
# These patterns detect compliance with FRR-UCM requirements for access control and capability management

---
pattern_id: ucm.rbac.role_definition
name: Role-Based Access Control Definition
family: UCM
severity: high
description: |
  Detects RBAC role definitions for user capability management.
  FRR-UCM requires well-defined roles with least privilege.
pattern_type: configuration
languages:
  - python
  - csharp
  - java
  - typescript
regex_patterns:
  - pattern: 'class.*Role|enum.*Role|ROLES\s*='
    flags: IGNORECASE
  - pattern: 'role.*admin|role.*user|role.*viewer'
    flags: IGNORECASE
  - pattern: '@role|@roles|@authorize'
    flags: IGNORECASE
finding_template:
  title: RBAC role definition detected
  description: Code defines roles for user capability management
  recommendation: Ensure roles follow least privilege principle per FRR-UCM-01
  references:
    - FRR-UCM-01
    - KSI-IAM-05

---
pattern_id: ucm.authorization.decorator
name: Authorization Decorator/Attribute
family: UCM
severity: high
description: Detects authorization decorators/attributes that enforce access control
pattern_type: decorator
languages:
  - python
  - csharp
  - java
  - typescript
ast_queries:
  - query_type: decorator
    target: "@require_permission"
  - query_type: decorator
    target: "@authorize"
  - query_type: decorator
    target: "[Authorize]"
  - query_type: decorator
    target: "@PreAuthorize"
  - query_type: decorator
    target: "@Secured"
regex_patterns:
  - pattern: '@require_permission|@authorize|@check_permission'
    flags: IGNORECASE
  - pattern: '\[Authorize\]|\[AllowAnonymous\]'
    flags: IGNORECASE
  - pattern: '@PreAuthorize|@Secured|@RolesAllowed'
    flags: IGNORECASE
finding_template:
  title: Authorization enforcement detected
  description: Code enforces authorization checks for user capabilities
  recommendation: Verify authorization logic aligns with defined RBAC roles
  references:
    - FRR-UCM-01
    - FRR-UCM-02

---
pattern_id: ucm.capability_check.explicit
name: Explicit Capability Check
family: UCM
severity: high
description: Detects explicit capability/permission checks in code
pattern_type: function_call
languages:
  - python
  - csharp
  - java
  - typescript
ast_queries:
  - query_type: function_call
    target: has_permission
  - query_type: function_call
    target: check_permission
  - query_type: function_call
    target: can_access
regex_patterns:
  - pattern: 'has_permission\(|check_permission\(|can_access\('
    flags: IGNORECASE
  - pattern: 'user\.has\(|user\.can\('
    flags: IGNORECASE
finding_template:
  title: Explicit capability check detected
  description: Code performs explicit permission/capability checks
  recommendation: Ensure checks are applied consistently across all sensitive operations
  references:
    - FRR-UCM-02

---
pattern_id: ucm.least_privilege.default_deny
name: Default Deny Access Control
family: UCM
severity: high
description: Detects default deny access control patterns
pattern_type: configuration
languages:
  - python
  - csharp
  - java
  - typescript
regex_patterns:
  - pattern: 'default.*deny|deny.*default|access.*denied'
    flags: IGNORECASE
  - pattern: 'if not.*permission.*return.*403|if not.*authorized.*return.*forbidden'
    flags: IGNORECASE
finding_template:
  title: Default deny access control detected
  description: Code implements default deny access control (least privilege)
  recommendation: Verify all endpoints/operations default to denied unless explicitly permitted
  references:
    - FRR-UCM-01
    - KSI-IAM-05

---
pattern_id: ucm.session.timeout
name: Session Timeout Configuration
family: UCM
severity: medium
description: Detects session timeout configuration for user capability management
pattern_type: configuration
languages:
  - python
  - csharp
  - java
  - typescript
regex_patterns:
  - pattern: 'session.*timeout|timeout.*session|SESSION_TIMEOUT'
    flags: IGNORECASE
  - pattern: 'idle.*timeout|inactivity.*timeout'
    flags: IGNORECASE
  - pattern: 'expires.*minutes|expiration.*time'
    flags: IGNORECASE
finding_template:
  title: Session timeout configured
  description: Code configures session timeouts for capability management
  recommendation: Ensure timeout complies with FedRAMP requirements (15 min for moderate)
  references:
    - FRR-UCM-03

---
pattern_id: ucm.audit.access_log
name: Access Logging for Capabilities
family: UCM
severity: high
description: Detects logging of capability/permission checks and access attempts
pattern_type: function_call
languages:
  - python
  - csharp
  - java
  - typescript
regex_patterns:
  - pattern: 'log.*access|audit.*permission|log.*authorization'
    flags: IGNORECASE
  - pattern: 'logger\.info.*permission|logger\.warn.*denied'
    flags: IGNORECASE
finding_template:
  title: Access logging for capabilities detected
  description: Code logs capability checks and access attempts
  recommendation: Ensure logs include user, resource, action, and result per FRR-ADS-02
  references:
    - FRR-UCM-04
    - FRR-ADS-02

---
pattern_id: ucm.missing_authorization
name: Missing Authorization Check
family: UCM
severity: critical
description: Detects API endpoints or sensitive operations without authorization checks
pattern_type: function_definition
languages:
  - python
  - csharp
  - java
  - typescript
regex_patterns:
  - pattern: '@app\.route|@api\.route|def.*api_'
    flags: IGNORECASE
requires_absence:
  - ucm.authorization.decorator
finding_template:
  title: API endpoint without authorization check
  description: Endpoint lacks authorization decorator/check
  severity: critical
  recommendation: Add @authorize or equivalent authorization check per FRR-UCM-01
  references:
    - FRR-UCM-01
    - FRR-UCM-02

---
pattern_id: ucm.iac.managed_identity
name: Azure Managed Identity for Capability Management
family: UCM
severity: high
description: Detects Azure Managed Identity configuration for service-to-service authorization
pattern_type: resource
languages:
  - bicep
  - terraform
ast_queries:
  - query_type: resource_type
    target: Microsoft.ManagedIdentity/userAssignedIdentities
  - query_type: resource_type
    target: azurerm_user_assigned_identity
regex_patterns:
  - pattern: 'identity\s*{.*type.*SystemAssigned'
    flags: IGNORECASE | DOTALL
  - pattern: 'Microsoft\.ManagedIdentity/userAssignedIdentities'
    flags: IGNORECASE
  - pattern: 'azurerm_user_assigned_identity'
    flags: IGNORECASE
finding_template:
  title: Azure Managed Identity for capability management
  description: IaC configures Managed Identity for service authorization
  recommendation: Assign least privilege roles using Azure RBAC
  references:
    - FRR-UCM-01
    - KSI-IAM-05

---
pattern_id: ucm.iac.rbac_assignment
name: Azure RBAC Role Assignment
family: UCM
severity: high
description: Detects Azure RBAC role assignments for capability management
pattern_type: resource
languages:
  - bicep
  - terraform
ast_queries:
  - query_type: resource_type
    target: Microsoft.Authorization/roleAssignments
  - query_type: resource_type
    target: azurerm_role_assignment
regex_patterns:
  - pattern: 'Microsoft\.Authorization/roleAssignments'
    flags: IGNORECASE
  - pattern: 'resource.*azurerm_role_assignment'
    flags: IGNORECASE
  - pattern: 'roleDefinitionId.*Reader|roleDefinitionId.*Contributor'
    flags: IGNORECASE
finding_template:
  title: Azure RBAC role assignment
  description: IaC assigns RBAC roles for user capability management
  recommendation: Verify role assignments follow least privilege principle
  references:
    - FRR-UCM-01

---
pattern_id: ucm.iac.key_vault_access_policy
name: Key Vault Access Policy
family: UCM
severity: high
description: Detects Key Vault access policies for capability-based secret access
pattern_type: resource
languages:
  - bicep
  - terraform
regex_patterns:
  - pattern: 'accessPolicies|access_policy'
    flags: IGNORECASE
  - pattern: 'permissions.*secrets|permissions.*keys|permissions.*certificates'
    flags: IGNORECASE
finding_template:
  title: Key Vault access policy for capability management
  description: IaC configures fine-grained access policies for secrets
  recommendation: Grant only required permissions (get/list, not all)
  references:
    - FRR-UCM-01
    - KSI-SVC-01

---
pattern_id: ucm.cicd.rbac_validation
name: CI/CD RBAC Validation Step
family: UCM
severity: medium
description: Detects CI/CD pipeline validation of RBAC configurations
pattern_type: pipeline
languages:
  - github_actions
  - azure_pipelines
  - gitlab_ci
regex_patterns:
  - pattern: 'name:.*[Vv]alidate.*RBAC|run:.*validate.*rbac'
    flags: IGNORECASE
  - pattern: 'script:.*check.*permissions|script:.*verify.*roles'
    flags: IGNORECASE
finding_template:
  title: RBAC validation in CI/CD
  description: Pipeline validates RBAC configurations before deployment
  recommendation: Include automated tests for least privilege compliance
  references:
    - FRR-UCM-01
