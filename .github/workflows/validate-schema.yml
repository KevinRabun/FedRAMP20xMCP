name: Validate MCP Schema

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'server.json'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'server.json'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read

jobs:
  validate-schema:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate server.json schema version
      run: |
        echo "Checking server.json schema version..."
        
        # Extract schema URL from server.json
        SCHEMA_URL=$(jq -r '."$schema"' server.json)
        echo "Current schema URL: $SCHEMA_URL"
        
        # Extract version from URL (e.g., 2025-12-11)
        SCHEMA_VERSION=$(echo "$SCHEMA_URL" | grep -oP '\d{4}-\d{2}-\d{2}')
        echo "Schema version: $SCHEMA_VERSION"
        
        if [ -z "$SCHEMA_VERSION" ]; then
          echo "::error::Could not extract schema version from server.json"
          exit 1
        fi
        
        # Validate that the schema URL is reachable
        echo "Validating schema URL is reachable..."
        HTTP_CODE=$(curl -sL -o /dev/null -w "%{http_code}" "$SCHEMA_URL")
        if [ "$HTTP_CODE" != "200" ]; then
          echo "::error::Schema URL returned HTTP $HTTP_CODE: $SCHEMA_URL"
          exit 1
        fi
        
        # Fetch the schema and extract its $id to verify it's valid JSON
        SCHEMA_RESPONSE=$(curl -sL "$SCHEMA_URL")
        if ! echo "$SCHEMA_RESPONSE" | jq empty 2>/dev/null; then
          echo "::error::Schema URL did not return valid JSON"
          exit 1
        fi
        
        SCHEMA_ID=$(echo "$SCHEMA_RESPONSE" | jq -r '."$id" // empty')
        if [ -n "$SCHEMA_ID" ]; then
          LATEST_VERSION=$(echo "$SCHEMA_ID" | grep -oP '\d{4}-\d{2}-\d{2}')
          echo "Schema \$id version: $LATEST_VERSION"
        fi
        
        if [ -z "$LATEST_VERSION" ]; then
          echo "::warning::Could not determine latest schema version from \$id, skipping version check"
          echo "✅ Schema URL is valid and reachable"
          exit 0
        fi
        
        # Compare versions
        if [ "$SCHEMA_VERSION" != "$LATEST_VERSION" ]; then
          echo ""
          echo "::warning::Schema version mismatch detected!"
          echo "  Current: $SCHEMA_VERSION"
          echo "  Latest:  $LATEST_VERSION"
          echo ""
          echo "Consider updating server.json \$schema to:"
          echo "  https://static.modelcontextprotocol.io/schemas/$LATEST_VERSION/server.schema.json"
        else
          echo "✅ Schema version is up to date: $SCHEMA_VERSION"
        fi
    
    - name: Validate server.json structure
      run: |
        echo "Validating server.json structure..."
        
        # Check required fields
        ERRORS=""
        
        if ! jq -e '.name' server.json > /dev/null 2>&1; then
          ERRORS="${ERRORS}Missing required field: name\n"
        fi
        
        if ! jq -e '.description' server.json > /dev/null 2>&1; then
          ERRORS="${ERRORS}Missing required field: description\n"
        fi
        
        if ! jq -e '.version' server.json > /dev/null 2>&1; then
          ERRORS="${ERRORS}Missing required field: version\n"
        fi
        
        # Check package structure if packages exist
        if jq -e '.packages' server.json > /dev/null 2>&1; then
          PACKAGE_COUNT=$(jq '.packages | length' server.json)
          for i in $(seq 0 $((PACKAGE_COUNT - 1))); do
            if ! jq -e ".packages[$i].registryType" server.json > /dev/null 2>&1; then
              ERRORS="${ERRORS}Package $i missing required field: registryType\n"
            fi
            if ! jq -e ".packages[$i].identifier" server.json > /dev/null 2>&1; then
              ERRORS="${ERRORS}Package $i missing required field: identifier\n"
            fi
            if ! jq -e ".packages[$i].transport" server.json > /dev/null 2>&1; then
              ERRORS="${ERRORS}Package $i missing required field: transport\n"
            fi
          done
        fi
        
        if [ -n "$ERRORS" ]; then
          echo "::error::server.json validation failed:"
          echo -e "$ERRORS"
          exit 1
        fi
        
        echo "✅ server.json structure is valid"
    
    - name: Check version consistency
      run: |
        echo "Checking version consistency across files..."
        
        SERVER_VERSION=$(jq -r '.version' server.json)
        PACKAGE_VERSION=$(jq -r '.packages[0].version // empty' server.json)
        PYPROJECT_VERSION=$(grep -oP 'version = "\K[^"]+' pyproject.toml | head -1)
        INIT_VERSION=$(grep -oP '__version__ = "\K[^"]+' src/fedramp_20x_mcp/__init__.py)
        
        echo "server.json version: $SERVER_VERSION"
        echo "server.json package version: $PACKAGE_VERSION"
        echo "pyproject.toml version: $PYPROJECT_VERSION"
        echo "__init__.py version: $INIT_VERSION"
        
        MISMATCH=""
        
        if [ "$SERVER_VERSION" != "$PYPROJECT_VERSION" ]; then
          MISMATCH="${MISMATCH}server.json ($SERVER_VERSION) != pyproject.toml ($PYPROJECT_VERSION)\n"
        fi
        
        if [ "$SERVER_VERSION" != "$INIT_VERSION" ]; then
          MISMATCH="${MISMATCH}server.json ($SERVER_VERSION) != __init__.py ($INIT_VERSION)\n"
        fi
        
        if [ -n "$PACKAGE_VERSION" ] && [ "$SERVER_VERSION" != "$PACKAGE_VERSION" ]; then
          MISMATCH="${MISMATCH}server.json version ($SERVER_VERSION) != package version ($PACKAGE_VERSION)\n"
        fi
        
        if [ -n "$MISMATCH" ]; then
          echo "::error::Version mismatch detected:"
          echo -e "$MISMATCH"
          exit 1
        fi
        
        echo "✅ All version numbers are consistent: $SERVER_VERSION"
