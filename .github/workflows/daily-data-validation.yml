name: Daily FedRAMP Data Validation

on:
  schedule:
    # Run daily at 6:00 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    # Allow manual triggering
    inputs:
      force_refresh:
        description: 'Force refresh from FedRAMP repo (bypass cache)'
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  issues: write  # For creating issues on failure

env:
  PYTHON_VERSION: '3.11'

jobs:
  validate-fedramp-data:
    name: Validate FedRAMP 20x Data Structure
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Run data structure validation
      id: validate
      run: python tests/validate_fedramp_data_structure.py
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        FORCE_REFRESH: ${{ github.event.inputs.force_refresh || 'true' }}
    
    - name: Run data loader tests
      run: pytest tests/test_data_loader.py -v
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create issue on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const title = 'ðŸš¨ Daily FedRAMP Data Validation Failed';
          const body = `## FedRAMP Data Structure Validation Failed
          
          The daily validation of the FedRAMP 20x data structure has failed.
          This could indicate:
          - Schema changes in the FedRAMP/docs repository
          - Network connectivity issues to GitHub API
          - Breaking changes to the data format
          
          **Workflow Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
          **Timestamp:** ${new Date().toISOString()}
          
          ### Action Required
          1. Check the workflow logs for specific validation failures
          2. Review recent changes to the [FedRAMP/docs repository](https://github.com/FedRAMP/docs)
          3. Update the data loader and validation tests if schema has changed
          
          /cc @${context.actor}`;
          
          // Check for existing open issues with same title
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'data-validation-failure'
          });
          
          const existingIssue = issues.data.find(issue => issue.title === title);
          
          if (existingIssue) {
            // Add comment to existing issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: `### Validation failed again\n\n**Workflow Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n**Timestamp:** ${new Date().toISOString()}`
            });
          } else {
            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'data-validation-failure', 'automated']
            });
          }

  test-mcp-server-startup:
    name: Test MCP Server Can Start
    runs-on: ubuntu-latest
    needs: validate-fedramp-data
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Test MCP server import and initialization
      run: |
        python -c "
        import asyncio
        from fedramp_20x_mcp.data_loader import FedRAMPDataLoader
        from fedramp_20x_mcp.server import create_server
        
        async def test_server():
            # Test data loader
            loader = FedRAMPDataLoader()
            data = await loader.load_data(force_refresh=True)
            print(f'âœ… Loaded {len(data[\"requirements\"])} requirements')
            print(f'âœ… Loaded {len(data[\"ksi\"])} KSIs')
            print(f'âœ… Loaded {len(data[\"definitions\"])} definitions')
            print(f'âœ… Found {len(data[\"families\"])} families')
            
            # Test server creation
            server = create_server()
            print('âœ… MCP server created successfully')
            
            return True
        
        result = asyncio.run(test_server())
        exit(0 if result else 1)
        "
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
